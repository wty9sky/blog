<!DOCTYPE html><html> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>Nestjså­¦ä¹ è®°å½•ï¼ˆä¸€ï¼‰ï¼šå¿«é€Ÿä¸Šæ‰‹ä¸åŸºç¡€æ¦‚å¿µ</title><link rel="icon" type="image/vnd.microsoft.icon" href="/favicon.ico"><link rel="sitemap" href="/sitemap-index.xml"><title>Nestjså­¦ä¹ è®°å½•ï¼ˆä¸€ï¼‰ï¼šå¿«é€Ÿä¸Šæ‰‹ä¸åŸºç¡€æ¦‚å¿µ</title><link rel="canonical" href="https://wty9sky.github.io/blog/detail/17/"><meta name="description" content="Nestjsçš„ä½¿ç”¨ï¼šåŒ…æ‹¬åˆ›å»ºé¡¹ç›®å’Œæ¨¡å—ï¼Œæ§åˆ¶å™¨ã€æœåŠ¡ã€æ¨¡å—ã€ä¸­é—´ä»¶ã€å¼‚å¸¸è¿‡æ»¤å™¨ã€ç®¡é“ã€å®ˆå«å’Œæ‹¦æˆªå™¨çš„ä½¿ç”¨ã€‚æ§åˆ¶å™¨å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼ŒæœåŠ¡å°è£…å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ¨¡å—ç®¡ç†æ‰€æœ‰æ§åˆ¶å™¨å’Œæä¾›è€…ï¼Œä¸­é—´ä»¶æ›´æ”¹è¯·æ±‚å“åº”å¯¹è±¡ï¼Œå¼‚å¸¸è¿‡æ»¤å™¨å¤„ç†æ‰€æœ‰æœªå¤„ç†çš„å¼‚å¸¸ï¼Œç®¡é“å¯¹å®¢æˆ·ç«¯æ•°æ®è¿›è¡Œè½¬æ¢å’ŒéªŒè¯ï¼Œå®ˆå«æ ¹æ®ç‰¹å®šçš„æƒé™è§’è‰²å†³å®šæ˜¯å¦è¿›è¡Œå¤„ç†ï¼Œæ‹¦æˆªå™¨å¯¹å¤„ç†å‡½æ•°è¿›è¡Œåˆ‡é¢ä¸Šçš„æ‰©å±•ã€‚
"><meta name="robots" content="index, follow"><meta property="og:title" content="Nestjså­¦ä¹ è®°å½•ï¼ˆä¸€ï¼‰ï¼šå¿«é€Ÿä¸Šæ‰‹ä¸åŸºç¡€æ¦‚å¿µ"><meta property="og:type" content="article"><meta property="og:image" content="/og.svg"><meta property="og:url" content="https://wty9sky.github.io/blog/detail/17/"><meta property="og:locale" content="zh_CN"><meta property="og:locale:alternate" content="zh_TW"><meta property="og:locale:alternate" content="en_US"><meta property="og:site_name" content="9Sky ä¹å¤©"><link rel="shortcut icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/avatar.png"><meta name="generator" content="Astro v4.16.7"><meta name="keywords" content="è¯¦æƒ…"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><link rel="stylesheet" href="/_astro/about.CkC6PiIh.css">
<link rel="stylesheet" href="/_astro/about.D3zQv4Ly.css"><script type="module" src="/_astro/hoisted.HO6_Fzad.js"></script></head> <body> <header class="header"> <h5 class="header__heading"> <a href="/" class="link">9Sky ä¹å¤©</a> <span>
/
<a href="/blog" class="link"> åšå®¢ </a> </span><span>
/
Nestjså­¦ä¹ è®°å½•ï¼ˆä¸€ï¼‰ï¼šå¿«é€Ÿä¸Šæ‰‹ä¸åŸºç¡€æ¦‚å¿µ </span> </h5> </header> <div id="navbar-sentinal"></div> <nav class="navbar" id="navbar-wrapper"> <div class="navbar__content"> <h5 class="navbar__path"> <a href="/" class="link">9Sky ä¹å¤©</a> <span>
/
<a href="/blog" class="link"> åšå®¢ </a> </span><span>
/
Nestjså­¦ä¹ è®°å½•ï¼ˆä¸€ï¼‰ï¼šå¿«é€Ÿä¸Šæ‰‹ä¸åŸºç¡€æ¦‚å¿µ </span> </h5> <div class="navbar__menu"> <ul data-astro-cid-tfcnbjmv> <li data-astro-cid-tfcnbjmv> <a class="link" href="/" data-astro-cid-tfcnbjmv> <i class="ri-home-line" data-astro-cid-tfcnbjmv></i>
ä¸»é¡µ
</a> </li> <li data-astro-cid-tfcnbjmv> <a class="link" href="/blog" data-astro-cid-tfcnbjmv> <i class="ri-newspaper-line" data-astro-cid-tfcnbjmv></i> æ–‡ç«  </a> </li><li data-astro-cid-tfcnbjmv> <a class="link" href="/projects" data-astro-cid-tfcnbjmv> <i class="ri-server-line" data-astro-cid-tfcnbjmv></i> é¡¹ç›® </a> </li><li data-astro-cid-tfcnbjmv> <a class="link" href="/lab" data-astro-cid-tfcnbjmv> <i class="ri-server-line" data-astro-cid-tfcnbjmv></i> å®éªŒå®¤ </a> </li><li data-astro-cid-tfcnbjmv> <a class="link" href="/about" data-astro-cid-tfcnbjmv> <i class="ri-cup-line" data-astro-cid-tfcnbjmv></i> å…³äº </a> </li> </ul>  </div> </div> </nav> <script>
  // ä½¿ç”¨ ViewTransition åï¼Œæ‰€æœ‰ DOM æ“ä½œçš„ js éƒ½æœ‰ä¸€å †é—®é¢˜
  // è¿™é‡Œç”¨äº†æä¸ä¼˜é›…çš„ varï¼Œæœ‰å¾…æ”¹è¿›
  var observer;
  function addNavObserver() {
    const headerEl = document.querySelector("#navbar-wrapper");
    const sentinalEl = document.querySelector("#navbar-sentinal");
    if (!sentinalEl || !headerEl) return;
    observer = new window.IntersectionObserver((e) => {
      if (!e[0].isIntersectin && e[0].boundingClientRect.top <= 0) {
        headerEl.classList.add("navbar--sticked");
      } else {
        headerEl.classList.remove("navbar--sticked");
      }
    });
    observer.observe(sentinalEl);
  }

  function removeNavObserver() {
    if (observer) observer.disconnect();
    observer = null;
  }

  document.addEventListener(
    "astro:page-load",
    () => {
      addNavObserver();
    },
    { once: false },
  );

  document.addEventListener(
    "astro:before-swap",
    () => {
      removeNavObserver();
    },
    { once: false },
  );
</script>  <main class="page"> <section class="page__section page__section--at-top"> <!-- {
        article.cover && (
          <a href={article.cover} data-fancybox data-caption={article.title}>
            <img
              src={article.cover}
              alt={article.title}
              title={article.title}
              class="page__cover mb-8"
            />
          </a>
        )
      } --> <h1 class="page__heading">Nestjså­¦ä¹ è®°å½•ï¼ˆä¸€ï¼‰ï¼šå¿«é€Ÿä¸Šæ‰‹ä¸åŸºç¡€æ¦‚å¿µ</h1> <p class="page__meta"> <i class="ri-calendar-line"></i> <span>2021 å¹´ 7 æœˆ 12 æ—¥ 10:32</span> </p> <hr class="page__divide"> <article class="content"> <h2><a id="æ–‡ç« ç›®å½•" class="content__heading-anchor"></a>æ–‡ç« ç›®å½•</h2>
<ul>
<li><a href="#nestjs%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B8%80%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E4%B8%8E%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5">Nestjså­¦ä¹ ç¬”è®°ï¼ˆä¸€ï¼‰ï¼šå¿«é€Ÿä¸Šæ‰‹ä¸åŸºç¡€æ¦‚å¿µ</a>
<ul>
<li><a href="#%E5%BF%AB%E9%80%9F%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE">å¿«é€Ÿåˆ›å»ºé¡¹ç›®</a></li>
<li><a href="#%E7%86%9F%E6%82%89%E5%85%B3%E9%94%AE%E6%96%87%E4%BB%B6">ç†Ÿæ‚‰å…³é”®æ–‡ä»¶</a></li>
<li><a href="#%E8%BF%90%E8%A1%8C%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F">è¿è¡Œåº”ç”¨ç¨‹åº</a></li>
<li><a href="#%E4%BB%8E%E6%A8%A1%E5%9D%97%E7%AE%A1%E7%90%86%E5%BC%80%E5%A7%8B">ä»æ¨¡å—ç®¡ç†å¼€å§‹</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%9D%97">åˆ›å»ºæ¨¡å—ï¼š</a></li>
<li><a href="#module-%E5%85%83%E6%95%B0%E6%8D%AE">@Module() å…ƒæ•°æ®</a></li>
<li><a href="#%E6%A8%A1%E5%9D%97%E5%86%8D%E5%AF%BC%E5%87%BA">æ¨¡å—å†å¯¼å‡º</a></li>
<li><a href="#%E5%85%A8%E5%B1%80%E6%A8%A1%E5%9D%97">å…¨å±€æ¨¡å—</a></li>
</ul></li>
<li><a href="#%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8">æ§åˆ¶å™¨çš„ä½¿ç”¨</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E6%8E%A7%E5%88%B6%E5%99%A8">åˆ›å»ºæ§åˆ¶å™¨</a></li>
<li><a href="#%E8%AF%BB%E5%8F%96%E8%AF%B7%E6%B1%82%E5%AF%B9%E8%B1%A1">è¯»å–è¯·æ±‚å¯¹è±¡</a></li>
<li><a href="#%E6%9B%B4%E5%A4%9A%E8%A3%85%E9%A5%B0%E5%99%A8">æ›´å¤šè£…é¥°å™¨</a></li>
</ul></li>
<li><a href="#%E6%8F%90%E4%BE%9B%E8%80%85%E7%9A%84%E4%BD%BF%E7%94%A8">æä¾›è€…çš„ä½¿ç”¨</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1">åˆ›å»ºæœåŠ¡</a></li>
<li><a href="#%E6%B3%A8%E5%85%A5%E5%B9%B6%E4%BD%BF%E7%94%A8">æ³¨å…¥å¹¶ä½¿ç”¨</a></li>
</ul></li>
<li><a href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8">ä¸­é—´ä»¶çš„ä½¿ç”¨</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E4%B8%AD%E9%97%B4%E4%BB%B6">åˆ›å»ºä¸­é—´ä»¶</a></li>
<li><a href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E9%97%B4%E4%BB%B6">æ³¨å†Œä¸­é—´ä»¶</a></li>
<li><a href="#%E8%8C%83%E5%9B%B4%E6%8E%A7%E5%88%B6">èŒƒå›´æ§åˆ¶</a></li>
<li><a href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%B8%B2%E8%81%94">ä¸­é—´ä»¶ä¸²è”</a></li>
<li><a href="#%E5%85%A8%E5%B1%80%E4%B8%AD%E9%97%B4%E4%BB%B6">å…¨å±€ä¸­é—´ä»¶</a></li>
</ul></li>
<li><a href="#%E5%AE%88%E5%8D%AB%E7%9A%84%E4%BD%BF%E7%94%A8">å®ˆå«çš„ä½¿ç”¨</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E5%AE%88%E5%8D%AB">åˆ›å»ºå®ˆå«</a></li>
<li><a href="#%E5%9F%BA%E4%BA%8E%E8%A7%92%E8%89%B2%E5%AE%88%E5%8D%AB">åŸºäºè§’è‰²å®ˆå«</a></li>
<li><a href="#%E7%BB%91%E5%AE%9A%E5%AE%88%E5%8D%AB">ç»‘å®šå®ˆå«</a></li>
</ul></li>
<li><a href="#%E6%8B%A6%E6%88%AA%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8">æ‹¦æˆªå™¨çš„ä½¿ç”¨</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E6%8B%A6%E6%88%AA%E5%99%A8">åˆ›å»ºæ‹¦æˆªå™¨</a></li>
<li><a href="#%E8%AE%B0%E5%BD%95%E6%89%A7%E8%A1%8C%E6%97%B6%E9%97%B4">è®°å½•æ‰§è¡Œæ—¶é—´</a></li>
<li><a href="#%E7%BB%91%E5%AE%9A%E6%8B%A6%E6%88%AA%E5%99%A8">ç»‘å®šæ‹¦æˆªå™¨</a></li>
<li><a href="#%E6%9B%B4%E5%A4%9A%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B">æ›´å¤šåº”ç”¨æ¡ˆä¾‹</a></li>
</ul></li>
<li><a href="#%E5%BC%82%E5%B8%B8%E8%BF%87%E6%BB%A4%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8">å¼‚å¸¸è¿‡æ»¤å™¨çš„ä½¿ç”¨</a>
<ul>
<li><a href="#%E6%A0%87%E5%87%86%E5%BC%82%E5%B8%B8">æ ‡å‡†å¼‚å¸¸</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8">è‡ªå®šä¹‰å¼‚å¸¸</a></li>
<li><a href="#%E5%86%85%E7%BD%AE-http-%E5%BC%82%E5%B8%B8">å†…ç½® HTTP å¼‚å¸¸</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA-http-%E5%BC%82%E5%B8%B8%E8%BF%87%E6%BB%A4%E5%99%A8">åˆ›å»º HTTP å¼‚å¸¸è¿‡æ»¤å™¨</a></li>
<li><a href="#%E7%BB%91%E5%AE%9A%E8%BF%87%E6%BB%A4%E5%99%A8">ç»‘å®šè¿‡æ»¤å™¨</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E9%80%9A%E7%94%A8%E5%BC%82%E5%B8%B8%E8%BF%87%E6%BB%A4%E5%99%A8">åˆ›å»ºé€šç”¨å¼‚å¸¸è¿‡æ»¤å™¨</a></li>
</ul></li>
<li><a href="#%E7%AE%A1%E9%81%93%E7%9A%84%E4%BD%BF%E7%94%A8">ç®¡é“çš„ä½¿ç”¨</a>
<ul>
<li><a href="#%E7%BB%91%E5%AE%9A%E7%AE%A1%E9%81%93">ç»‘å®šç®¡é“</a></li>
<li><a href="#%E5%9F%BA%E4%BA%8E-schema-%E7%9A%84%E9%AA%8C%E8%AF%81">åŸºäº schema çš„éªŒè¯</a></li>
<li><a href="#%E5%9F%BA%E4%BA%8E-class-%E7%9A%84%E9%AA%8C%E8%AF%81">åŸºäº class çš„éªŒè¯</a></li>
</ul></li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
</ul></li>
</ul>
<h1><a id="nestjså­¦ä¹ ç¬”è®°ä¸€å¿«é€Ÿä¸Šæ‰‹ä¸åŸºç¡€æ¦‚å¿µ" class="content__heading-anchor"></a>Nestjså­¦ä¹ ç¬”è®°ï¼ˆä¸€ï¼‰ï¼šå¿«é€Ÿä¸Šæ‰‹ä¸åŸºç¡€æ¦‚å¿µ</h1>
<p><strong>NestJS</strong> æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºé«˜æ•ˆã€å¯æ‰©å±•çš„ <strong>Node.js</strong> æœåŠ¡å™¨ç«¯åº”ç”¨ç¨‹åºçš„æ¡†æ¶ã€‚å®ƒé‡‡ç”¨äº†æ¸è¿›å¼ <strong>JavaScript</strong> ï¼Œä½¿ç”¨ <strong>TypeScript</strong> æ„å»ºå¹¶å®Œå…¨æ”¯æŒ <strong>TypeScript</strong>ï¼ˆä½†ä»å…è®¸å¼€å‘äººå‘˜ä½¿ç”¨çº¯<strong>JavaScript</strong> ç¼–ç ï¼‰ï¼Œå¹¶ç»“åˆäº†<strong>OOP</strong>ï¼ˆé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼‰ã€<strong>FP</strong>ï¼ˆé¢å‘å‡½æ•°ç¼–ç¨‹ï¼‰å’Œ <strong>FRP</strong>ï¼ˆé¢å‘å‡½æ•°çš„å“åº”å¼ç¼–ç¨‹ï¼‰çš„å…ƒç´ ã€‚</p>
<h2><a id="å¿«é€Ÿåˆ›å»ºé¡¹ç›®" class="content__heading-anchor"></a>å¿«é€Ÿåˆ›å»ºé¡¹ç›®</h2>
<p>å…¨å±€å®‰è£…è„šæ‰‹æ¶å¹¶å¯ç”¨ä¸¥æ ¼æ¨¡å¼åˆ›å»ºé¡¹ç›®ï¼›</p>
<pre><code class="language-powershell"><span class="hljs-comment">## å…¨å±€å®‰è£…è„šæ‰‹æ¶</span>
npm i <span class="hljs-literal">-g</span> @nestjs/<span class="hljs-built_in">cli</span>
<span class="hljs-comment">## å¯ç”¨ Typescript ä¸¥æ ¼æ¨¡å¼åˆ›å»ºé¡¹ç›®</span>
nest new project <span class="hljs-literal">--strict</span>
</code></pre>
<h2><a id="ç†Ÿæ‚‰å…³é”®æ–‡ä»¶" class="content__heading-anchor"></a>ç†Ÿæ‚‰å…³é”®æ–‡ä»¶</h2>
<p><code>src</code>ç›®å½•æ˜¯ä¸»è¦çš„æºç ç›®å½•ï¼Œä¸»è¦ç”±å…¥å£æ–‡ä»¶ <code>main.ts</code> å’Œ ä¸€ç»„ <code>module</code>ï¼Œ<code>service</code>ï¼Œ<code>controller</code>æ„æˆã€‚</p>
<pre><code>project
â”œâ”€ src
â”‚  â”œâ”€ app.controller.ts          # ä¸šåŠ¡æ•°æ®äº¤äº’çš„å…¥å£ï¼Œå®ç°æ•°æ®åœ¨å‰åç«¯çš„äº¤äº’
â”‚  â”œâ”€ app.service.ts           # å°è£…ä¸šåŠ¡é€»è¾‘ï¼Œå°†é‡å¤çš„ä¸šåŠ¡é€»è¾‘åœ¨æœåŠ¡å±‚è¿›è¡Œå°è£…
â”‚  â”œâ”€ app.module.ts            # è´Ÿè´£æ¨¡å—çš„ç®¡ç†ï¼Œé€šå¸¸ app.module è´Ÿè´£å…¨å±€æ¨¡å—çš„ç®¡ç†
â”‚  â””â”€ main.ts                  # å…¥å£æ–‡ä»¶ï¼Œåˆ›å»ºåº”ç”¨å®ä¾‹
â”œâ”€ README.md
â”œâ”€ nest-cli.json
â”œâ”€ package.json
â”œâ”€ tsconfig.build.json
â””â”€ tsconfig.json
</code></pre>
<h2><a id="è¿è¡Œåº”ç”¨ç¨‹åº" class="content__heading-anchor"></a>è¿è¡Œåº”ç”¨ç¨‹åº</h2>
<ol>
<li>æ™®é€šå¯åŠ¨æ¨¡å¼ï¼š<code>npm run start</code></li>
<li>ç›‘å¬å¯åŠ¨æ¨¡å¼ï¼š<code>npm run start:dev</code></li>
<li>è°ƒè¯•å¯åŠ¨æ¨¡å¼ï¼š<code>npm run start:debug</code></li>
</ol>
<h2><a id="ä»æ¨¡å—ç®¡ç†å¼€å§‹" class="content__heading-anchor"></a>ä»æ¨¡å—ç®¡ç†å¼€å§‹</h2>
<p><strong>Nestjs</strong> æ˜¯å…¸å‹çš„é‡‡ç”¨æ¨¡å—åŒ–ç»„ç»‡åº”ç”¨ç»“æ„çš„æ¡†æ¶ï¼Œé€šè¿‡ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªåº”ç”¨ç”±ä¸€ä¸ªæ ¹æ¨¡å—(<strong>Application Module</strong>)å’Œå¤šä¸ªåŠŸèƒ½æ¨¡å—å…±åŒç»„æˆã€‚</p>
<h3><a id="åˆ›å»ºæ¨¡å—" class="content__heading-anchor"></a>åˆ›å»ºæ¨¡å—ï¼š</h3>
<ul>
<li>å®Œæ•´å‘½ä»¤ï¼š<code>nest generate module &lt;module-name&gt;</code></li>
<li>ç®€å†™å‘½ä»¤ï¼š<code>nest g mo &lt;module-name&gt;</code></li>
</ul>
<p>æ¯ä¸ªæ¨¡å—éƒ½æ˜¯ä¸€ä¸ªç”±<code>@Module()</code>è£…é¥°å™¨æ³¨é‡Šçš„ç±»ï¼Œåº”ç”¨ä¸­æ¨¡å—é—´çš„å…³ç³»å°†ç”±<code>@Module()</code>è£…é¥°å™¨ä¸­æºå¸¦çš„æ‰€æœ‰å…ƒæ•°æ®æè¿°ã€‚</p>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">providers</span>: [],
  <span class="hljs-attr">imports</span>: [],
  <span class="hljs-attr">controllers</span>: [],
  <span class="hljs-attr">exports</span>: [],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrdersModule</span> {}
</code></pre>
<h3><a id="module-å…ƒæ•°æ®" class="content__heading-anchor"></a>@Module() å…ƒæ•°æ®</h3>
<p>é€šè¿‡ <strong>Orders</strong> æ¨¡å—äº†è§£<code>@Module()</code>å…ƒæ•°æ®å¦‚ä½•ç»„ç»‡æ¨¡å—ï¼š</p>
<p>/tab</p>
<table>
<thead>
<tr><th>providers</th><th>æ³¨å†Œè®¢å•æä¾›è€…æ¨¡å—ï¼Œå¦‚ï¼šè´Ÿè´£è®¢å• CRUD çš„æœåŠ¡ï¼›</th></tr>
</thead>
<tbody>
<tr><td>controllers</td><td>æ³¨å†Œè®¢å•æ§åˆ¶å™¨æ¨¡å—ï¼Œå¦‚ï¼šè´Ÿè´£è®¢å• CRUD çš„è·¯ç”±å¤„ç†ï¼›</td></tr>
<tr><td>imports</td><td>æ³¨å†Œä¸è®¢å•ç›¸å…³è”çš„æ¨¡å—ï¼Œå¦‚ï¼šä¸è®¢å•å…³è”çš„ç”¨æˆ·æŸ¥è¯¢æœåŠ¡ï¼›</td></tr>
<tr><td>exports</td><td>å¯¼å‡ºè®¢å•æä¾›è€…æ¨¡å—ï¼Œå¦‚ï¼šç”¨æˆ·æŸ¥è¯¢éœ€è¦è®¢å•æä¾›è€…ç»Ÿè®¡è®¢å•æ•°é‡ï¼›</td></tr>
</tbody>
</table>
<p>ğŸ’¡ PSï¼š<strong>Orders</strong> æ¨¡å—é€šè¿‡<code>exports</code>å°†è®¢å•æä¾›è€…æ¨¡å—å¯¼å‡ºçš„è¡Œä¸ºç§°ä¸º<strong>æ¨¡å—å…±äº«</strong>ï¼›</p>
<h3><a id="æ¨¡å—å†å¯¼å‡º" class="content__heading-anchor"></a>æ¨¡å—å†å¯¼å‡º</h3>
<p>ä¸€ä¸ªæ¨¡å—ä»…è´Ÿè´£å°†ä¸€ç³»åˆ—ç›¸å…³è”çš„æ¨¡å—é€šè¿‡<code>imports</code>å¯¼å…¥ï¼Œç´§æ¥ç€å°±é€šè¿‡<code>exports</code>å…¨éƒ¨å¯¼å‡ºçš„è¡Œä¸ºå°±æ˜¯æ¨¡å—åœ¨å¯¼å‡ºï¼Œåˆ©ç”¨<strong>æ¨¡å—å†å¯¼å‡º</strong>çš„èƒ½åŠ›ï¼Œå¯ä»¥å‡å°‘å¤§é‡å…³è”æ¨¡å—é‡å¤å¯¼å…¥é€ æˆçš„è´Ÿæ‹…ã€‚</p>
<pre><code class="language-tsx"><span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DatabaseModule</span>, <span class="hljs-title class_">RedisModule</span>, <span class="hljs-title class_">MongoModule</span>],
  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">DatabaseModule</span>, <span class="hljs-title class_">RedisModule</span>, <span class="hljs-title class_">MongoModule</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionModule</span> {}
</code></pre>
<p>ğŸ’¡ PSï¼šåœ¨éœ€è¦åŒæ—¶ä½¿ç”¨æ•°æ®åº“è¿æ¥ã€Redis è¿æ¥ã€Mongo è¿æ¥çš„æƒ…å†µä¸‹ä»…éœ€è¦å¯¼ <strong>ConnectionModule</strong> æ¨¡å—å³å¯ã€‚</p>
<h3><a id="å…¨å±€æ¨¡å—" class="content__heading-anchor"></a>å…¨å±€æ¨¡å—</h3>
<p>å¦‚æœéœ€è¦ <strong>ConnectionModule</strong> æ¨¡å—åœ¨ä»»ä½•åœ°æ–¹éƒ½èƒ½å¼€ç®±å³ç”¨ï¼Œé‚£å¯ä»¥ä¸ºå…¶å¢åŠ  <code>@Global()</code> è£…é¥°å™¨ï¼›</p>
<pre><code class="language-tsx"><span class="hljs-meta">@Global</span>()
<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DatabaseModule</span>, <span class="hljs-title class_">RedisModule</span>, <span class="hljs-title class_">MongoModule</span>],
  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">DatabaseModule</span>, <span class="hljs-title class_">RedisModule</span>, <span class="hljs-title class_">MongoModule</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionModule</span> {}
</code></pre>
<h2><a id="æ§åˆ¶å™¨çš„ä½¿ç”¨" class="content__heading-anchor"></a>æ§åˆ¶å™¨çš„ä½¿ç”¨</h2>
<p>æ§åˆ¶å™¨ç”¨æ¥æ¥æ”¶å’Œå¤„ç†å®¢æˆ·ç«¯å‘èµ·çš„ç‰¹å®šè¯·æ±‚ï¼Œä¸åŒçš„å®¢æˆ·ç«¯è¯·æ±‚å°†ç”± <strong>Nestjs</strong> è·¯ç”±æœºåˆ¶åˆ†é…åˆ°å¯¹åº”çš„æ§åˆ¶å™¨è¿›è¡Œå¤„ç†ã€‚</p>
<h3><a id="åˆ›å»ºæ§åˆ¶å™¨" class="content__heading-anchor"></a>åˆ›å»ºæ§åˆ¶å™¨</h3>
<ul>
<li>å®Œæ•´å‘½ä»¤ï¼š<code>nest generate controller &lt;controller-name&gt;</code></li>
<li>ç®€å†™å‘½ä»¤ï¼š<code>nest g co &lt;controller-name&gt;</code></li>
</ul>
<p>æ§åˆ¶å™¨æ˜¯ä½¿ç”¨<code>@Controller(â€™pathâ€™)</code>è£…é¥°å™¨æ³¨é‡Šçš„ç±»ï¼Œå…¶ä¸­<code>path</code>æ˜¯ä¸€ä¸ªå¯é€‰çš„è·¯ç”±è·¯å¾„å‰ç¼€ï¼Œé€šè¿‡<code>path</code>å¯ä»¥å°†ç›¸å…³çš„è·¯ç”±è¿›è¡Œåˆ†ç»„ã€‚</p>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">&quot;orders&quot;</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrdersController</span> {
  <span class="hljs-meta">@Get</span>()
  <span class="hljs-title function_">index</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;This is the order controller&quot;</span>;
  }
}
</code></pre>
<p>ğŸ’¡ å°ç»“ï¼š</p>
<ol>
<li>å½“å®¢æˆ·ç«¯é€šè¿‡ <strong>GET</strong> æ–¹æ³•å¯¹ <code>orders</code> è·¯ç”±å‘é€è¯·æ±‚æ—¶å°†ç”± <code>index()</code> å¤„ç†å‡½æ•°å“åº”ã€‚</li>
<li>é™¤<code>@Get()</code>è£…é¥°å™¨å¤–ï¼Œ<strong>Nestjs</strong> è¿˜ä¸º <strong>HTTP</strong> æ ‡å‡†æ–¹æ³•æä¾›çš„è£…é¥°æœ‰<code>@Post()</code>ã€<code>@Put()</code>ã€<code>@Delete()</code>ã€<code>@Patch()</code>ã€<code>@Options()</code>å’Œ<code>@Head()</code>ï¼Œä»¥åŠ<code>@All()</code>ç”¨æ¥å¤„ç†æ‰€æœ‰çš„æƒ…å†µã€‚</li>
<li><code>@Controller(â€™pathâ€™)</code>ä¸­çš„ <code>path</code> ä»è®¾è®¡ä¸Šè™½ä¸ºå¯é€‰å‚æ•°ï¼Œä½†åœ¨å®é™…é¡¹ç›®ä¸­æœªé¿å…æ··ä¹±ä¼šåœ¨åˆ›å»ºæ§åˆ¶å™¨åä¼˜å…ˆåˆ†é… <code>path</code>ã€‚</li>
</ol>
<h3><a id="è¯»å–è¯·æ±‚å¯¹è±¡" class="content__heading-anchor"></a>è¯»å–è¯·æ±‚å¯¹è±¡</h3>
<p>è¯·æ±‚å¯¹è±¡è¡¨ç¤ºä¸€ä¸ª <strong>HTTP</strong> è¯·æ±‚æ‰€æºå¸¦çš„æ•°æ®ä¿¡æ¯ï¼Œå¦‚è¯·æ±‚æ•°æ®ä¸­çš„æŸ¥è¯¢å‚æ•°ã€è·¯ç”±å‚æ•°ã€è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ç­‰æ•°æ®ã€‚é€šè¿‡åœ¨ <strong>OrdersController</strong> æ§åˆ¶å™¨ä¸­ç¼–å†™æ›´å¤šçš„å¤„ç†æ–¹æ³•æ¥æ¼”ç¤ºæ¥æ”¶ä¸åŒçš„ <strong>HTTP</strong> æ–¹æ³•å’Œä¸åŒä½ç½®çš„å‚æ•°ï¼š</p>
<ol>
<li>é€šè¿‡ <strong>GET</strong> æ–¹æ³•è·å–è®¢å•åˆ—è¡¨æ•°æ®ï¼Œå¹¶é€šè¿‡<strong>æŸ¥è¯¢å‚æ•°</strong>ä¼ é€’è®¢å•åˆ†é¡µæ•°æ®ï¼š</li>
</ol>
<pre><code class="language-tsx"><span class="hljs-meta">@Get</span>(<span class="hljs-string">&#x27;list&#x27;</span>)
<span class="hljs-title function_">list</span>(<span class="hljs-params"><span class="hljs-meta">@Query</span>(<span class="hljs-string">&#x27;page&#x27;</span>) <span class="hljs-attr">page</span>: <span class="hljs-built_in">number</span>, <span class="hljs-meta">@Query</span>(<span class="hljs-string">&#x27;limit&#x27;</span>) <span class="hljs-attr">limit</span>: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`è·å–ç¬¬<span class="hljs-subst">${page}</span>é¡µï¼Œæ¯é¡µ<span class="hljs-subst">${limit}</span>æ¡è®¢å•`</span>;
}
</code></pre>
<pre><code class="language-powershell"><span class="hljs-built_in">curl</span> <span class="hljs-literal">--request</span> GET \
  <span class="hljs-literal">--url</span> <span class="hljs-string">&#x27;http://localhost:3000/orders/list?page=1&amp;limit=20&#x27;</span>
</code></pre>
<ol>
<li>é€šè¿‡ <strong>GET</strong> æ–¹æ³•æŸ¥è¯¢æŒ‡å®š ID çš„è®¢å•è¯¦æƒ…ï¼Œå¹¶é€šè¿‡<strong>è·¯ç”±å‚æ•°</strong>ä¼ é€’è®¢å• IDï¼›</li>
</ol>
<pre><code class="language-tsx"><span class="hljs-meta">@Get</span>(<span class="hljs-string">&#x27;detail/:id&#x27;</span>)
<span class="hljs-title function_">findById</span>(<span class="hljs-params"><span class="hljs-meta">@Param</span>() <span class="hljs-attr">param</span>: { id: <span class="hljs-built_in">number</span> }</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`è·å– ID ä¸º <span class="hljs-subst">${param.id}</span> çš„è®¢å•è¯¦æƒ…`</span>;
}
</code></pre>
<pre><code class="language-powershell"><span class="hljs-built_in">curl</span> <span class="hljs-literal">--request</span> GET \
  <span class="hljs-literal">--url</span> http://localhost:<span class="hljs-number">3000</span>/orders/detail/<span class="hljs-number">1</span>
</code></pre>
<ol>
<li>é€šè¿‡ <strong>PATCH</strong> æ–¹æ³•æ›´æ–°æŒ‡å®š ID è®¢å•çš„æœ€æ–°çŠ¶æ€ï¼Œå¹¶é€šè¿‡è·¯ç”±å‚æ•°ä¼ é€’è®¢å• ID åŠæœ€æ–°çŠ¶æ€ï¼›</li>
</ol>
<pre><code class="language-tsx"><span class="hljs-meta">@Patch</span>(<span class="hljs-string">&#x27;:id/:status&#x27;</span>)
<span class="hljs-title function_">updateByIdAndStatus</span>(<span class="hljs-params">
  <span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;id&#x27;</span>) <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>,
  <span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;status&#x27;</span>) <span class="hljs-attr">status</span>: <span class="hljs-built_in">string</span>,
</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`å°† ID ä¸º <span class="hljs-subst">${id}</span> è®¢å•çŠ¶æ€æ›´æ–°ä¸º <span class="hljs-subst">${status}</span>`</span>;
}
</code></pre>
<pre><code class="language-powershell"><span class="hljs-built_in">curl</span> <span class="hljs-literal">--request</span> PATCH \
  <span class="hljs-literal">--url</span> <span class="hljs-string">&#x27;http://localhost:3000/orders/1/å·²é€€æ¬¾&#x27;</span>
</code></pre>
<ol>
<li>é€šè¿‡ <strong>POST</strong> æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„è®¢å•ï¼Œå¹¶é€šè¿‡è¯·æ±‚ä½“ <strong>Body</strong> æ¥æ”¶è®¢å•æ•°æ®ï¼›</li>
</ol>
<pre><code class="language-tsx"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ICreateOrder</span> {
  <span class="hljs-attr">article</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">source</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-meta">@Post</span>()
<span class="hljs-title function_">create</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>() <span class="hljs-attr">order</span>: <span class="hljs-title class_">ICreateOrder</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`åˆ›å»ºè®¢å•ï¼Œè®¢å•ä¿¡æ¯ä¸º <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(order)}</span>`</span>;
}
</code></pre>
<pre><code class="language-powershell"><span class="hljs-built_in">curl</span> <span class="hljs-literal">--request</span> POST \
  <span class="hljs-literal">--url</span> http://localhost:<span class="hljs-number">3000</span>/orders \
  <span class="hljs-literal">--header</span> <span class="hljs-string">&#x27;content-type: application/json&#x27;</span> \
  <span class="hljs-literal">--data</span> <span class="hljs-string">&#x27;{
    &quot;article&quot;: &quot;HUAWEI-Meta60&quot;,
    &quot;price&quot;: 5999,
    &quot;count&quot;: 1,
    &quot;source&quot;: &quot;Made in China&quot;
}&#x27;</span>
</code></pre>
<p>ğŸ’¡ å°ç»“ï¼š</p>
<ol>
<li>æ§åˆ¶å™¨ä¸­ä¸åŒçš„å¤„ç†å‡½æ•°å¯ä»¥é€šè¿‡ <strong>HTTP</strong> æ–¹æ³•æ¥åŒºåˆ†ï¼›</li>
<li>å½“å¤šä¸ªå¤„ç†å‡½æ•°éœ€è¦ä½¿ç”¨ç›¸åŒçš„ <strong>HTTP</strong> æ–¹æ³•æ—¶éœ€è¦æ·»åŠ å¤„ç†å‡½æ•°çº§åˆ«çš„è·¯ç”±ä»¥ç¤ºåŒºåˆ†ï¼›</li>
<li><code>@Param()</code>æœªæŒ‡å®šå‚æ•°æ—¶è¡¨ç¤ºæ‰€æœ‰è·¯ç”±å‚æ•°çš„é›†åˆï¼ŒæŒ‡å®šå‚æ•°æ—¶è¡¨ç¤ºå¯¹åº”æŒ‡å®šçš„å‚æ•°ï¼Œ<code>@Query()</code>ä¸<code>@Param()</code>å…·æœ‰ç›¸åŒçš„ç‰¹ç‚¹ã€‚</li>
</ol>
<h3><a id="æ›´å¤šè£…é¥°å™¨" class="content__heading-anchor"></a>æ›´å¤šè£…é¥°å™¨</h3>
<ol>
<li>@Header(key, value)ï¼š</li>
</ol>
<pre><code class="language-tsx"><span class="hljs-meta">@Post</span>()
<span class="hljs-meta">@Header</span>(<span class="hljs-string">&#x27;Cache-Control&#x27;</span>, <span class="hljs-string">&#x27;none&#x27;</span>)
<span class="hljs-title function_">create</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>() <span class="hljs-attr">createOrderDto</span>: <span class="hljs-title class_">CreateOrderDto</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ordersService</span>.<span class="hljs-title function_">create</span>(createOrderDto);
}
</code></pre>
<ol>
<li>@Redirect(res, statusCode)</li>
</ol>
<pre><code class="language-tsx"><span class="hljs-meta">@Get</span>(<span class="hljs-string">&#x27;:id&#x27;</span>)
<span class="hljs-meta">@Redirect</span>(<span class="hljs-string">&#x27;https://nestjs.com/&#x27;</span>, <span class="hljs-number">301</span>)
<span class="hljs-title function_">findOne</span>(<span class="hljs-params"><span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;id&#x27;</span>) <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ordersService</span>.<span class="hljs-title function_">findOne</span>(+id);
}
</code></pre>
<p>ğŸ’¡ å°ç»“ï¼š</p>
<ol>
<li>301ï¼šèµ„æºè¢«æ°¸ä¹…é‡å®šå‘åˆ°æ–°çš„èµ„æºï¼Œå®¢æˆ·ç«¯éœ€è¦è€ƒè™‘åŒæ­¥æ›´æ–°ï¼›</li>
<li>302ï¼šèµ„æºè¢«ä¸´æ—¶é‡å®šå‘åˆ°æ–°çš„èµ„æºï¼Œå¦‚ï¼šæœåŠ¡ç«¯å‡çº§æ—¶ä¼šå¯ç”¨ä¸´æ—¶èµ„æºï¼›</li>
</ol>
<p>ä¸‹é¢åˆ—å‡ºçš„å†…ç½®è£…é¥°å™¨å¯ç®€åŒ–è¯·æ±‚æ•°æ®ä¿¡æ¯çš„è¯»å–ï¼š</p>
<table>
<thead>
<tr><th>@Request(), @Req()</th><th>req</th></tr>
</thead>
<tbody>
<tr><td>@Response(), @Res()*</td><td>res</td></tr>
<tr><td>@Next()</td><td>next</td></tr>
<tr><td>@Session()</td><td>req.session</td></tr>
<tr><td>@Param(key?: string)</td><td>req.params / req.params[key]</td></tr>
<tr><td>@Body(key?: string)</td><td>req.body / req.body[key]</td></tr>
<tr><td>@Query(key?: string)</td><td>req.query / req.query[key]</td></tr>
<tr><td>@Headers(name?: string)</td><td>req.headers / req.headers[name]</td></tr>
<tr><td>@Ip()</td><td>req.ip</td></tr>
<tr><td>@HostParam()</td><td>req.hosts</td></tr>
</tbody>
</table>
<h2><a id="æä¾›è€…çš„ä½¿ç”¨" class="content__heading-anchor"></a>æä¾›è€…çš„ä½¿ç”¨</h2>
<p>åœ¨ Nestjs ä¸­å°†æä¾›æœåŠ¡çš„ç±»åŠä¸€äº›å·¥å‚ç±»ã€åŠ©æ‰‹ç±»ç­‰ç§°ä½œæä¾›è€…ï¼Œå®ƒä»¬åŒæ—¶å‡å¯ä»¥é€šè¿‡æ³¨å…¥çš„æ–¹å¼ä½œä¸ºä¾èµ–æ¨¡å—ï¼›</p>
<h3><a id="åˆ›å»ºæœåŠ¡" class="content__heading-anchor"></a>åˆ›å»ºæœåŠ¡</h3>
<ul>
<li>å®Œæ•´å‘½ä»¤ï¼š<code>nest generate service orders</code>ï¼›</li>
<li>ç®€å†™å‘½ä»¤ï¼š<code>nest g s orders</code>ï¼›</li>
</ul>
<p>æœåŠ¡æ˜¯å…¸å‹çš„æä¾›è€…ï¼ŒHTTP è¯·æ±‚åœ¨ç»è¿‡æ§åˆ¶å™¨å¤„ç†ååº”è¯¥å°†å¤æ‚çš„ä»»åŠ¡äº¤ç”±æœåŠ¡å±‚è¿›è¡Œå¤„ç†ï¼Œå¦‚ï¼šå°†å¤æ‚çš„è®¢å•ç”Ÿæˆã€æŸ¥è¯¢ã€æ›´æ–°åŠåˆ é™¤ç­‰æ“ä½œè¿›è¡Œå°è£…ã€‚</p>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CreateOrderDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./dto/create-order.dto&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UpdateOrderDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./dto/update-order.dto&quot;</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrdersService</span> {
  <span class="hljs-title function_">create</span>(<span class="hljs-params"><span class="hljs-attr">createOrderDto</span>: <span class="hljs-title class_">CreateOrderDto</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;This action adds a new order&quot;</span>;
  }

  <span class="hljs-title function_">findAll</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`This action returns all orders`</span>;
  }

  <span class="hljs-title function_">findOne</span>(<span class="hljs-params"><span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`This action returns a #<span class="hljs-subst">${id}</span> order`</span>;
  }

  <span class="hljs-title function_">update</span>(<span class="hljs-params"><span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">updateOrderDto</span>: <span class="hljs-title class_">UpdateOrderDto</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`This action updates a #<span class="hljs-subst">${id}</span> order`</span>;
  }

  <span class="hljs-title function_">remove</span>(<span class="hljs-params"><span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`This action removes a #<span class="hljs-subst">${id}</span> order`</span>;
  }
}
</code></pre>
<p>ğŸ’¡ PSï¼š<strong>Nestjs</strong> åº”ç”¨å¯åŠ¨æ—¶å¿…é¡»è§£æå…¨éƒ¨ä¾èµ–ï¼Œå› æ­¤æ¯ä¸ªæä¾›è€…éƒ½å°†å®ä¾‹åŒ–å®Œæˆï¼ŒåŒæ—¶åœ¨åº”ç”¨åœæ­¢åæ¯ä¸ªæä¾›è€…å°†å…¨éƒ¨è¢«é”€æ¯ï¼Œæ‰€ä»¥é»˜è®¤çš„æä¾›è€…ç”Ÿå‘½å‘¨æœŸåŒåº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<h3><a id="æ³¨å…¥å¹¶ä½¿ç”¨" class="content__heading-anchor"></a>æ³¨å…¥å¹¶ä½¿ç”¨</h3>
<p>å°† <strong>OrdersService</strong> é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥åˆ° <strong>OrdersController</strong> æ§åˆ¶å™¨ï¼Œè¿™æ ·å°±å¾—åˆ°äº†åˆå§‹åŒ–åçš„ <strong>ordersService</strong> æˆå‘˜ï¼Œæ¥ç€å°±å¯ä»¥åœ¨ä¸åŒçš„å¤„ç†å‡½æ•°è°ƒç”¨æœåŠ¡ä¸­æä¾›çš„èƒ½åŠ›ã€‚</p>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span>, <span class="hljs-title class_">Post</span>, <span class="hljs-title class_">Body</span>, <span class="hljs-title class_">Param</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrdersService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./orders.service&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CreateOrderDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./dto/create-order.dto&quot;</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">&quot;orders&quot;</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrdersController</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">ordersService</span>: <span class="hljs-title class_">OrdersService</span></span>) {}

  <span class="hljs-meta">@Post</span>()
  <span class="hljs-title function_">create</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>() <span class="hljs-attr">createOrderDto</span>: <span class="hljs-title class_">CreateOrderDto</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ordersService</span>.<span class="hljs-title function_">create</span>(createOrderDto);
  }

  <span class="hljs-meta">@Get</span>()
  <span class="hljs-title function_">findAll</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ordersService</span>.<span class="hljs-title function_">findAll</span>();
  }

  <span class="hljs-meta">@Get</span>(<span class="hljs-string">&quot;:id&quot;</span>)
  <span class="hljs-title function_">findOne</span>(<span class="hljs-params"><span class="hljs-meta">@Param</span>(<span class="hljs-string">&quot;id&quot;</span>) <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ordersService</span>.<span class="hljs-title function_">findOne</span>(+id);
  }
}
</code></pre>
<p>ğŸ’¡ PSï¼š</p>
<p>é™¤æ„é€ å‡½æ•°æ³¨å…¥çš„è¿™ç§æ–¹å¼å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡å±æ€§æ³¨å…¥ï¼š</p>
<pre><code class="language-tsx"><span class="hljs-meta">@Inject</span>()
<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">ordersService</span>: <span class="hljs-title class_">OrdersService</span>;
</code></pre>
<h2><a id="ä¸­é—´ä»¶çš„ä½¿ç”¨" class="content__heading-anchor"></a>ä¸­é—´ä»¶çš„ä½¿ç”¨</h2>
<p>ä¸­é—´ä»¶æ˜¯è·¯ç”±å¤„ç†ç¨‹åºä¹‹å‰è¿è¡Œçš„å‡½æ•°ï¼Œåœ¨ä¸­é—´ä»¶ä¸­å¯ä»¥è®¿é—® request å’Œ response å¯¹è±¡ï¼Œä»¥åŠå°†æ§åˆ¶æƒä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶çš„<code>next()</code>å‡½æ•°ã€‚</p>
<h3><a id="åˆ›å»ºä¸­é—´ä»¶" class="content__heading-anchor"></a>åˆ›å»ºä¸­é—´ä»¶</h3>
<ul>
<li>å®Œæ•´å‘½ä»¤ï¼š<code>nest generate middleware &lt;middleware-name&gt;</code></li>
<li>ç®€å†™å‘½ä»¤ï¼š<code>nest g mi &lt;middleware-name&gt;</code></li>
</ul>
<p>ä¸­é—´ä»¶æ˜¯ä¸€ä¸ªä½¿ç”¨<code>@Injectable()</code>è£…é¥°å™¨æ³¨é‡Šä¸”å®ç°<strong>NestMiddleware</strong>æ¥å£çš„ç±»ï¼Œ</p>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">NestMiddleware</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Request</span>, <span class="hljs-title class_">Response</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;express&quot;</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggerMiddleware</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestMiddleware</span> {
  <span class="hljs-title function_">use</span>(<span class="hljs-params"><span class="hljs-attr">req</span>: <span class="hljs-title class_">Request</span>, <span class="hljs-attr">res</span>: <span class="hljs-title class_">Response</span>, <span class="hljs-attr">next</span>: () =&gt; <span class="hljs-built_in">void</span></span>) {
    <span class="hljs-keyword">const</span> start = process.<span class="hljs-title function_">hrtime</span>();
    res.<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;finish&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> diff = process.<span class="hljs-title function_">hrtime</span>(start);
      <span class="hljs-keyword">const</span> time = (diff[<span class="hljs-number">0</span>] * <span class="hljs-number">1e3</span> + diff[<span class="hljs-number">1</span>] * <span class="hljs-number">1e-6</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">3</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.url}</span> - <span class="hljs-subst">${time}</span>ms`</span>);
    });
    <span class="hljs-title function_">next</span>();
  }
}
</code></pre>
<p>ğŸ’¡ PSï¼šå¯¹äºæ²¡æœ‰å±æ€§ã€æ²¡æœ‰é¢å¤–çš„å‡½æ•°ä¹Ÿæ²¡æœ‰é¢å¤–çš„ä¾èµ–çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªæ™®é€šçš„å‡½æ•°æ¥è¡¨ç¤ºä¸­é—´ä»¶ï¼Œè¿™ç±»ä¸­é—´ä»¶æˆä¸º<strong>åŠŸèƒ½ç±»ä¸­é—´ä»¶</strong>ã€‚</p>
<h3><a id="æ³¨å†Œä¸­é—´ä»¶" class="content__heading-anchor"></a>æ³¨å†Œä¸­é—´ä»¶</h3>
<p>ä¸­é—´ä»¶çš„æ³¨å†Œäºæ§åˆ¶å™¨å’Œæä¾›è€…çš„æ³¨å†Œæ–¹å¼ä¸åŒï¼Œéœ€è¦åœ¨æ¶ˆè´¹ä¸­é—´ä»¶çš„æ¨¡å—é€šè¿‡ç»§æ‰¿ <strong>NestModule</strong> å¹¶å®ç° <code>configure</code> æ¥å£ï¼Œå¦‚ä¸‹é¢æˆ‘ä»¬åœ¨è®¢å•æ¨¡å—ä¸­æ³¨å†Œäº†è¿™ä¸ª <strong>Logger</strong> ä¸­é—´ä»¶ï¼š</p>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">MiddlewareConsumer</span>, <span class="hljs-title class_">Module</span>, <span class="hljs-title class_">NestModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrdersService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./orders.service&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrdersController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./orders.controller&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LoggerMiddleware</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;src/logger/logger.middleware&quot;</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">OrdersController</span>],
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">OrdersService</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrdersModule</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestModule</span> {
  <span class="hljs-title function_">configure</span>(<span class="hljs-params"><span class="hljs-attr">consumer</span>: <span class="hljs-title class_">MiddlewareConsumer</span></span>) {
    consumer.<span class="hljs-title function_">apply</span>(<span class="hljs-title class_">LoggerMiddleware</span>).<span class="hljs-title function_">forRoutes</span>(<span class="hljs-string">&quot;orders&quot;</span>);
  }
}
</code></pre>
<p>ğŸ’¡ PSï¼š<code>forRoutes()</code>æ”¯æŒå¤šç§å½¢å¼çš„å‚æ•°æ¥è¡¨ç¤ºç”Ÿæ•ˆçš„èŒƒå›´ï¼Œå¦‚ï¼šå•å­—ç¬¦ä¸²ã€å¤šä¸ªå­—ç¬¦ä¸²ã€RouteInfo å¯¹è±¡ã€å•ä¸ªæ§åˆ¶å™¨ç±»æˆ–å¤šä¸ªæ§åˆ¶å™¨ç±»ã€‚</p>
<h3><a id="èŒƒå›´æ§åˆ¶" class="content__heading-anchor"></a>èŒƒå›´æ§åˆ¶</h3>
<p><strong>MiddlewareConsumer</strong> æä¾›äº†<code>exclude</code>å‡½æ•°æ¥æŒ‰è§„åˆ™æ’é™¤ä¸€äº›ä¸åº”ç”¨ä¸­é—´ä»¶çš„è·¯ç”±ï¼Œå…·ä½“çš„è§„åˆ™å¯è§ <a href="https://github.com/pillarjs/path-to-regexp#parameters">path-to-regexp</a>ï¼š</p>
<pre><code class="language-tsx"><span class="hljs-comment">// åŸºäºå…·ä½“è·¯ç”±é…ç½®åŠæ¨¡å¼åŒ¹é…çš„æ’é™¤æ–¹æ¡ˆ</span>
consumer
  .<span class="hljs-title function_">apply</span>(<span class="hljs-title class_">LoggerMiddleware</span>)
  .<span class="hljs-title function_">exclude</span>(
    { <span class="hljs-attr">path</span>: <span class="hljs-string">&quot;orders&quot;</span>, <span class="hljs-attr">method</span>: <span class="hljs-title class_">RequestMethod</span>.<span class="hljs-property">GET</span> },
    { <span class="hljs-attr">path</span>: <span class="hljs-string">&quot;orders&quot;</span>, <span class="hljs-attr">method</span>: <span class="hljs-title class_">RequestMethod</span>.<span class="hljs-property">POST</span> },
    <span class="hljs-string">&quot;orders/(.*)&quot;</span>
  )
  .<span class="hljs-title function_">forRoutes</span>(<span class="hljs-string">&quot;orders&quot;</span>);
</code></pre>
<p><strong>MiddlewareConsumer</strong> æä¾›çš„ <code>forRoutes</code>æ”¯æŒä¸‹é¢è¿™ç§æ¨¡å¼åŒ¹é…çš„æ–¹å¼ï¼š</p>
<pre><code class="language-tsx"><span class="hljs-title function_">forRoutes</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">&quot;ab*cd&quot;</span>, <span class="hljs-attr">method</span>: <span class="hljs-title class_">RequestMethod</span>.<span class="hljs-property">ALL</span> });
</code></pre>
<h3><a id="ä¸­é—´ä»¶ä¸²è”" class="content__heading-anchor"></a>ä¸­é—´ä»¶ä¸²è”</h3>
<p>å½“ä¸€ä¸ªä¸­é—´ä»¶å¤„ç†å®Œæˆåï¼Œå¦‚æœè¯·æ±‚è¿˜æ²¡æœ‰ç»“æŸå°†æœ‰<code>next()</code>å‡½æ•°å°†æ§åˆ¶æƒå‘ä¸‹ä¼ é€’ã€‚å¦‚ä¸‹é¢è¿™ä¸ªç¤ºä¾‹ï¼šä¸ºäº†å…è®¸å®¢æˆ·ç«¯å‘èµ·è·¨åŸŸè®¿é—®ï¼Œåœ¨ <strong>Cors</strong> ä¸­é—´ä»¶ä¸­ä¸ºæ¯ä¸€ä¸ªè¯·æ±‚æ·»åŠ ç‰¹æ®Šçš„è¯·æ±‚å¤´åå†äº¤ç”± <strong>Logger</strong> ä¸­é—´ä»¶ç»§ç»­æ‰§è¡Œã€‚</p>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">NestMiddleware</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Request</span>, <span class="hljs-title class_">Response</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;express&quot;</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CorsMiddleware</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestMiddleware</span> {
  <span class="hljs-title function_">use</span>(<span class="hljs-params"><span class="hljs-attr">req</span>: <span class="hljs-title class_">Request</span>, <span class="hljs-attr">res</span>: <span class="hljs-title class_">Response</span>, <span class="hljs-attr">next</span>: () =&gt; <span class="hljs-built_in">void</span></span>) {
    res.<span class="hljs-title function_">header</span>(<span class="hljs-string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>); <span class="hljs-comment">// å…è®¸æ‰€æœ‰æ¥æº</span>
    res.<span class="hljs-title function_">header</span>(<span class="hljs-string">&quot;Access-Control-Allow-Headers&quot;</span>, <span class="hljs-string">&quot;Content-Type,Authorization&quot;</span>); <span class="hljs-comment">// å…è®¸æŒ‡å®šçš„è¯·æ±‚å¤´</span>
    res.<span class="hljs-title function_">header</span>(
      <span class="hljs-string">&quot;Access-Control-Allow-Methods&quot;</span>,
      <span class="hljs-string">&quot;GET, POST, PUT, DELETE, OPTIONS&quot;</span>
    ); <span class="hljs-comment">// å…è®¸æŒ‡å®šçš„è¯·æ±‚æ–¹æ³•</span>
    <span class="hljs-title function_">next</span>();
  }
}
</code></pre>
<pre><code class="language-tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrdersModule</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestModule</span> {
  <span class="hljs-title function_">configure</span>(<span class="hljs-params"><span class="hljs-attr">consumer</span>: <span class="hljs-title class_">MiddlewareConsumer</span></span>) {
    consumer.<span class="hljs-title function_">apply</span>(<span class="hljs-title class_">CorsMiddleware</span>, <span class="hljs-title class_">LoggerMiddleware</span>).<span class="hljs-title function_">forRoutes</span>(<span class="hljs-string">&quot;orders&quot;</span>);
  }
}
</code></pre>
<h3><a id="å…¨å±€ä¸­é—´ä»¶" class="content__heading-anchor"></a>å…¨å±€ä¸­é—´ä»¶</h3>
<p>å…¨å±€æ³¨å†Œ <strong>ç±»ä¸­é—´ä»¶</strong>ï¼Œå¯ä»¥åœ¨æ ¹æ¨¡å— <strong>AppModule</strong> ä¸­æ³¨å†Œï¼Œä½¿ç”¨é€šé…ç¬¦çš„å½¢å¼è¡¨ç¤º <code>forRoutes('*')</code>ï¼š</p>
<pre><code class="language-tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestModule</span> {
  <span class="hljs-title function_">configure</span>(<span class="hljs-params"><span class="hljs-attr">consumer</span>: <span class="hljs-title class_">MiddlewareConsumer</span></span>) {
    consumer.<span class="hljs-title function_">apply</span>(<span class="hljs-title class_">CorsMiddleware</span>, <span class="hljs-title class_">LoggerMiddleware</span>).<span class="hljs-title function_">forRoutes</span>(<span class="hljs-string">&quot;*&quot;</span>);
  }
}
</code></pre>
<p>å¦‚æœéœ€è¦å…¨å±€æ³¨å†Œ <strong>åŠŸèƒ½ç±»ä¸­é—´ä»¶</strong> ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨åˆ›å»º <strong>app</strong> å®ä¾‹åï¼Œé€šè¿‡ <code>app.use('')</code> å‡½æ•°æ³¨å†Œï¼š</p>
<pre><code class="language-tsx"><span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>);
app.<span class="hljs-title function_">use</span>(logger);
<span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);
</code></pre>
<h2><a id="å®ˆå«çš„ä½¿ç”¨" class="content__heading-anchor"></a>å®ˆå«çš„ä½¿ç”¨</h2>
<p>å®ˆå«ä¾æ®æœåŠ¡è¿è¡ŒæœŸé—´çš„æƒé™ã€è§’è‰²åŠè®¿é—®æ§åˆ¶åˆ—è¡¨ç­‰æ¡ä»¶æ¥ç¡®å®šå®¢æˆ·ç«¯çš„è®¿é—®æ˜¯å¦äº¤ç”±è·¯ç”±å¤„ç†ç¨‹åºå¤„ç†ã€‚ç›¸æ¯”äºä¼ ç»Ÿçš„ä¸­é—´ä»¶å……å½“å®ˆå«çš„è§’è‰²è€Œè¨€ ï¼ŒNestJS æä¾›çš„å®ˆå«æ”¯æŒè®¿é—®<code>ExecutionContext</code> ****å®ä¾‹ï¼Œå› æ­¤å¯ä»¥æ˜ç¡®çŸ¥é“æ¥ç€è¦æ‰§è¡Œä»€ä¹ˆã€‚</p>
<h3><a id="åˆ›å»ºå®ˆå«" class="content__heading-anchor"></a>åˆ›å»ºå®ˆå«</h3>
<ul>
<li>å®Œæ•´å‘½ä»¤ï¼š<code>nest generate guard &lt;guard-name&gt;</code></li>
<li>ç®€å†™å‘½ä»¤ï¼š<code>nest g gu &lt;guard-name&gt;</code></li>
</ul>
<p>å®ˆå«ä¹Ÿæ˜¯ä¸€ä¸ªä½¿ç”¨<code>@Injectable()</code>è£…é¥°å™¨æ³¨é‡Šçš„ç±»ï¼Œå®ƒéœ€è¦å®ç° <code>CanActivate</code> æ¥å£ï¼š</p>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CanActivate</span>, <span class="hljs-title class_">ExecutionContext</span>, <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Observable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;rxjs&quot;</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RolesGuard</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CanActivate</span> {
  <span class="hljs-title function_">canActivate</span>(
    <span class="hljs-attr">context</span>: <span class="hljs-title class_">ExecutionContext</span>
  ): <span class="hljs-built_in">boolean</span> | <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; | <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
}
</code></pre>
<h3><a id="åŸºäºè§’è‰²å®ˆå«" class="content__heading-anchor"></a>åŸºäºè§’è‰²å®ˆå«</h3>
<p>é¦–å…ˆè¦ä½¿ç”¨<code>Reflector</code>åˆ›å»ºä¸€ä¸ªç”¨æ¥åˆ†é…è§’è‰²çš„è£…é¥°å™¨ï¼Œç„¶ååœ¨å¯¹åº”çš„è·¯ç”±å¤„ç†å‡½æ•°ä¸Šæ·»åŠ è¿™ä¸ªè£…é¥°å™¨å¹¶åˆ†é…æƒé™ï¼›</p>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Reflector</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/core&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Roles</span> = <span class="hljs-title class_">Reflector</span>.<span class="hljs-property">createDecorator</span>&lt;<span class="hljs-built_in">string</span>[]&gt;();
</code></pre>
<pre><code class="language-tsx">
<span class="hljs-meta">@Roles</span>([<span class="hljs-string">&#x27;admin&#x27;</span>])
<span class="hljs-meta">@Post</span>()
<span class="hljs-title function_">create</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>() <span class="hljs-attr">createOrderDto</span>: <span class="hljs-title class_">CreateOrderDto</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ordersService</span>.<span class="hljs-title function_">create</span>(createOrderDto);
}
</code></pre>
<p>æ¥ç€åœ¨<code>RolesGuard</code> ä¸­é€šè¿‡ <strong>æ‰§è¡Œä¸Šä¸‹æ–‡ç±»</strong> è·å–è¢«è°ƒç”¨å¤„ç†å‡½æ•°çš„å¼•ç”¨ï¼Œå¹¶æ³¨å…¥<code>Reflector</code>æ¥æå–å¤„ç†å‡½æ•°è¢«åˆ†é…çš„è§’è‰²ï¼š</p>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CanActivate</span>, <span class="hljs-title class_">ExecutionContext</span>, <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Reflector</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/core&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Observable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;rxjs&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Roles</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./roles.decorator&quot;</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RolesGuard</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CanActivate</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">reflector</span>: <span class="hljs-title class_">Reflector</span></span>) {}
  <span class="hljs-title function_">canActivate</span>(
    <span class="hljs-attr">context</span>: <span class="hljs-title class_">ExecutionContext</span>
  ): <span class="hljs-built_in">boolean</span> | <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; | <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {
    <span class="hljs-keyword">const</span> handler = context.<span class="hljs-title function_">getHandler</span>();
    <span class="hljs-keyword">const</span> roles = <span class="hljs-variable language_">this</span>.<span class="hljs-property">reflector</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">string</span>[]&gt;(<span class="hljs-title class_">Roles</span>, handler);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(roles); <span class="hljs-comment">// output [&#x27;admin&#x27;]</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
}
</code></pre>
<p>ç°åœ¨å‡è®¾ä¸å®¢æˆ·ç«¯åå•†é€šè¿‡ <strong>Header</strong> ä¸­æ·»åŠ  <code>role</code> å±æ€§æ¥ä¼ é€’è§’è‰²ä¿¡æ¯ï¼Œé‚£ä¹ˆåœ¨<code>RolesGuard</code>ä¸­å¯ä»¥é€šè¿‡æ‰§è¡Œä¸Šä¸‹æ–‡è·å– <strong>Request</strong> å¯¹è±¡ä¸­çš„è¯·æ±‚å¤´æ•°æ®ï¼Œæœ€åå¯¹æ¯”è§’è‰²åˆ—è¡¨ï¼Œå¹¶è¿”å›æ˜¯å¦åŒ…å«è§’è‰²çš„ç»“æœï¼š</p>
<pre><code>import { CanActivate, ExecutionContext, Injectable } from &#x27;@nestjs/common&#x27;;
import { Reflector } from &#x27;@nestjs/core&#x27;;
import { Observable } from &#x27;rxjs&#x27;;
import { Roles } from &#x27;./roles.decorator&#x27;;
import { Request } from &#x27;express&#x27;;

@Injectable()
export class RolesGuard implements CanActivate {
  constructor(private readonly reflector: Reflector) {}
  canActivate(
    context: ExecutionContext,
  ): boolean | Promise&lt;boolean&gt; | Observable&lt;boolean&gt; {
    const handler = context.getHandler();
    const roles = this.reflector.get&lt;string[]&gt;(Roles, handler);
    const request: Request = context.switchToHttp().getRequest();
    const role = request.headers[&#x27;role&#x27;] || &#x27;&#x27;;
    return roles.includes(role as string);
  }
}
</code></pre>
<h3><a id="ç»‘å®šå®ˆå«" class="content__heading-anchor"></a>ç»‘å®šå®ˆå«</h3>
<p>æ§åˆ¶å™¨èŒƒå›´ç»‘å®šï¼š</p>
<pre><code class="language-tsx"><span class="hljs-meta">@Controller</span>(<span class="hljs-string">&quot;orders&quot;</span>)
<span class="hljs-meta">@UseGuards</span>(<span class="hljs-title class_">RolesGuard</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrdersController</span> {}

<span class="hljs-comment">// or</span>

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">&quot;orders&quot;</span>)
<span class="hljs-meta">@UseGuards</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RolesGuard</span>())
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrdersController</span> {}
</code></pre>
<p>å…¨å±€èŒƒå›´ç»‘å®šï¼š</p>
<pre><code class="language-tsx"><span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>);
app.<span class="hljs-title function_">useGlobalGuards</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RolesGuard</span>());

<span class="hljs-comment">// or</span>

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">providers</span>: [
    {
      <span class="hljs-attr">provide</span>: <span class="hljs-variable constant_">APP_GUARD</span>,
      <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">RolesGuard</span>,
    },
  ],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}
</code></pre>
<h2><a id="æ‹¦æˆªå™¨çš„ä½¿ç”¨" class="content__heading-anchor"></a>æ‹¦æˆªå™¨çš„ä½¿ç”¨</h2>
<p>æ‹¦æˆªå™¨æ˜¯åº”ç”¨ AOP åˆ‡é¢ç¼–ç¨‹æ¨¡å¼æ¥å¯¹è·¯ç”±å¤„ç†å‡½æ•°è¿›è¡ŒåŠŸèƒ½æ‰©å±•çš„æŠ€æœ¯ï¼Œé€šè¿‡æ‹¦æˆªå™¨å¯ä»¥æ‰©å±•ä¸‹é¢è¿™äº›èƒ½åŠ›ï¼š</p>
<ul>
<li>åœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰/ä¹‹åç»‘å®šé¢å¤–çš„é€»è¾‘</li>
<li>è½¬æ¢å‡½æ•°è¿”å›çš„ç»“æœ</li>
<li>è½¬æ¢å‡½æ•°æŠ›å‡ºçš„å¼‚å¸¸</li>
<li>æ‰©å±•åŸºæœ¬åŠŸèƒ½è¡Œä¸º</li>
<li>æ ¹æ®ç‰¹å®šæ¡ä»¶å®Œå…¨è¦†ç›–å‡½æ•°ï¼ˆä¾‹å¦‚ï¼Œç¼“å­˜ï¼‰</li>
</ul>
<h3><a id="åˆ›å»ºæ‹¦æˆªå™¨" class="content__heading-anchor"></a>åˆ›å»ºæ‹¦æˆªå™¨</h3>
<ul>
<li>å®Œæ•´å‘½ä»¤ï¼š<code>nest generate interceptor &lt;interceptor-name&gt;</code></li>
<li>ç®€å†™å‘½ä»¤ï¼š<code>nest g itc &lt;interceptor-name&gt;</code></li>
</ul>
<p>æ‹¦æˆªå™¨ä¹Ÿæ˜¯ä¸€ä¸ªä½¿ç”¨<code>@Injectable()</code>è£…é¥°å™¨æ³¨é‡Šçš„ç±»ï¼Œå®ƒéœ€è¦å®ç° <code>NestInterceptor</code> æ¥å£ï¼š</p>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">CallHandler</span>,
  <span class="hljs-title class_">ExecutionContext</span>,
  <span class="hljs-title class_">Injectable</span>,
  <span class="hljs-title class_">NestInterceptor</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Observable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;rxjs&quot;</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimerInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestInterceptor</span> {
  <span class="hljs-title function_">intercept</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">ExecutionContext</span>, <span class="hljs-attr">next</span>: <span class="hljs-title class_">CallHandler</span>): <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>();
  }
}
</code></pre>
<h3><a id="è®°å½•æ‰§è¡Œæ—¶é—´" class="content__heading-anchor"></a>è®°å½•æ‰§è¡Œæ—¶é—´</h3>
<p>å½“å®¢æˆ·ç«¯çš„è¯·æ±‚è§¦å‘åˆ° <strong>TimerInterceptor</strong> æ‹¦æˆªå™¨æ—¶ï¼Œå°†è·å–åˆ°è¯·æ±‚å¯¹è±¡å®ä¾‹ï¼Œå¹¶è®°å½•ä¸‹äº†è¯·æ±‚è¿›å…¥çš„æ—¶é—´ç‚¹ï¼›</p>
<p>å½“ <code>next.handle()</code> å‡½æ•°è¿”å›ç»“æœåè¡¨ç¤ºå¯¹åº”çš„è·¯ç”±å¤„ç†å‡½æ•°å·²ç»æ‰§è¡Œå®Œæˆã€‚é€šè¿‡è¿”å›çš„ <strong>Observable</strong> å¯¹è±¡ï¼Œå¯ä»¥åœ¨å…¶ç®¡é“ä¸­ä½¿ç”¨ <code>tap</code> æ“ä½œç¬¦è®°å½•ç»“æŸæ—¶é—´å¹¶æ‰“å°æ‰§è¡Œæ—¶é•¿ä¿¡æ¯ã€‚</p>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">CallHandler</span>,
  <span class="hljs-title class_">ExecutionContext</span>,
  <span class="hljs-title class_">Injectable</span>,
  <span class="hljs-title class_">NestInterceptor</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Observable</span>, tap } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;rxjs&quot;</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimerInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestInterceptor</span> {
  <span class="hljs-title function_">intercept</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">ExecutionContext</span>, <span class="hljs-attr">next</span>: <span class="hljs-title class_">CallHandler</span>): <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-keyword">const</span> req = context.<span class="hljs-title function_">switchToHttp</span>().<span class="hljs-title function_">getRequest</span>();
    <span class="hljs-keyword">const</span> start = process.<span class="hljs-title function_">hrtime</span>();

    <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>().<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">tap</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> diff = process.<span class="hljs-title function_">hrtime</span>(start);
        <span class="hljs-keyword">const</span> time = (diff[<span class="hljs-number">0</span>] * <span class="hljs-number">1e3</span> + diff[<span class="hljs-number">1</span>] * <span class="hljs-number">1e-6</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">3</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.url}</span> - <span class="hljs-subst">${time}</span>ms`</span>);
      })
    );
  }
}
</code></pre>
<h3><a id="ç»‘å®šæ‹¦æˆªå™¨" class="content__heading-anchor"></a>ç»‘å®šæ‹¦æˆªå™¨</h3>
<p>æ§åˆ¶å™¨èŒƒå›´ç»‘å®šï¼š</p>
<pre><code class="language-tsx"><span class="hljs-meta">@UseInterceptors</span>(<span class="hljs-title class_">TimerInterceptor</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrdersController</span> {}

<span class="hljs-comment">// or</span>

<span class="hljs-meta">@UseInterceptors</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TimerInterceptor</span>())
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrdersController</span> {}
</code></pre>
<p>å…¨å±€èŒƒå›´ç»‘å®šï¼š</p>
<pre><code class="language-tsx"><span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>);
app.<span class="hljs-title function_">useGlobalInterceptors</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TimerInterceptor</span>());

<span class="hljs-comment">// or</span>

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">providers</span>: [
    {
      <span class="hljs-attr">provide</span>: <span class="hljs-variable constant_">APP_INTERCEPTOR</span>,
      <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">TimerInterceptor</span>,
    },
  ],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}
</code></pre>
<h3><a id="æ›´å¤šåº”ç”¨æ¡ˆä¾‹" class="content__heading-anchor"></a>æ›´å¤šåº”ç”¨æ¡ˆä¾‹</h3>
<ol>
<li>å“åº”æ˜ å°„ï¼šä½¿ç”¨<strong>Rxjs</strong>æä¾›çš„<code>map</code>æ“ä½œç¬¦å¯¹å¤„ç†å‡½æ•°è¿”å›çš„æ•°æ®åšäºŒæ¬¡åŠ å·¥ï¼š</li>
</ol>
<pre><code class="language-tsx"><span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransformInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestInterceptor</span> {
  <span class="hljs-title function_">intercept</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">ExecutionContext</span>, <span class="hljs-attr">next</span>: <span class="hljs-title class_">CallHandler</span>): <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>().<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">time</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
          data,
        };
      })
    );
  }
}
</code></pre>
<ol>
<li>å¼‚å¸¸æ˜ å°„ï¼šä½¿ç”¨<strong>Rxjs</strong>æä¾›çš„<code>catchError</code>æ“ä½œç¬¦æŠ›å‡ºæŒ‡å®šçš„å¼‚å¸¸ï¼š</li>
</ol>
<pre><code class="language-tsx"><span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorsInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestInterceptor</span> {
  <span class="hljs-title function_">intercept</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">ExecutionContext</span>, <span class="hljs-attr">next</span>: <span class="hljs-title class_">CallHandler</span>): <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-keyword">return</span> next
      .<span class="hljs-title function_">handle</span>()
      .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">catchError</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> <span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadGatewayException</span>())));
  }
}
</code></pre>
<ol>
<li>å¤„ç†å‡½æ•°è¶…æ—¶ï¼šä½¿ç”¨<strong>Rxjs</strong>æä¾›çš„<code>timeout</code>å’Œ<code>catchError</code>å…±åŒå®ç°å¤„ç†å‡½æ•°è¶…æ—¶ï¼š</li>
</ol>
<pre><code class="language-tsx"><span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimeoutInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestInterceptor</span> {
  <span class="hljs-title function_">intercept</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">ExecutionContext</span>, <span class="hljs-attr">next</span>: <span class="hljs-title class_">CallHandler</span>): <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>().<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">timeout</span>(<span class="hljs-number">5</span> * <span class="hljs-number">1000</span>),
      <span class="hljs-title function_">catchError</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (err <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">TimeoutError</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestTimeoutException</span>());
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> err);
      })
    );
  }
}
</code></pre>
<h2><a id="å¼‚å¸¸è¿‡æ»¤å™¨çš„ä½¿ç”¨" class="content__heading-anchor"></a>å¼‚å¸¸è¿‡æ»¤å™¨çš„ä½¿ç”¨</h2>
<p><strong>NestJS</strong> å†…ç½®çš„ <strong>å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨</strong> è´Ÿè´£å¤„ç†åº”ç”¨ä¸­æ‰€æœ‰æœªå¤„ç†çš„ <strong>HttpException</strong> åŠå…¶å­ç±»çš„å¼‚å¸¸ï¼Œå…¶ä»–å¼‚å¸¸å°†ç”±å†…ç½®è¿‡æ»¤å™¨ç”Ÿæˆé»˜è®¤çš„ JSON å“åº”ï¼š</p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;statusCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">500</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Internal server error&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3><a id="æ ‡å‡†å¼‚å¸¸" class="content__heading-anchor"></a>æ ‡å‡†å¼‚å¸¸</h3>
<p>é€šè¿‡å®ä¾‹åŒ– <strong>NestJs</strong> å†…ç½®çš„ <code>HttpException</code> ç±»æ¥æŠ›å‡ºçš„å¼‚å¸¸ä¸ºæ ‡å‡†å¼‚å¸¸ï¼Œä¸‹é¢çš„ä»£ç å±•ç¤ºäº†ç”± <code>message</code> å’Œ <code>statusCode</code> ç»„æˆçš„æ ‡å‡†ç¤ºä¾‹ï¼š</p>
<pre><code class="language-tsx"><span class="hljs-meta">@Get</span>()
<span class="hljs-title function_">findAll</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpException</span>(<span class="hljs-string">&#x27;Forbidden&#x27;</span>, <span class="hljs-title class_">HttpStatus</span>.<span class="hljs-property">FORBIDDEN</span>);
}
</code></pre>
<p>ä¸‹é¢çš„ä»£ç å®Œå…¨è‡ªå®šä¹‰äº†æŠ›å‡ºå¼‚å¸¸çš„ <strong>JSON</strong> å“åº”ä½“ï¼š</p>
<pre><code class="language-tsx"><span class="hljs-meta">@Get</span>()
<span class="hljs-keyword">async</span> <span class="hljs-title function_">findAll</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// TODO</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpException</span>(
      {
        <span class="hljs-attr">status</span>: <span class="hljs-title class_">HttpStatus</span>.<span class="hljs-property">FORBIDDEN</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;This is a custom message&#x27;</span>,
      },
      <span class="hljs-title class_">HttpStatus</span>.<span class="hljs-property">FORBIDDEN</span>,
      {
        <span class="hljs-attr">cause</span>: error,
      },
    );
  }
}
</code></pre>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">403</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;This is a custom message&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3><a id="è‡ªå®šä¹‰å¼‚å¸¸" class="content__heading-anchor"></a>è‡ªå®šä¹‰å¼‚å¸¸</h3>
<p>ç»§æ‰¿ <code>HttpException</code> ç±»å¯ä»¥å°è£…ç¬¦åˆè‡ªå·±é¡¹ç›®çš„è‡ªå®šä¹‰å¼‚å¸¸ï¼Œæ­£å¦‚ä¸Šé¢å®Œå…¨è‡ªå®šä¹‰æŠ›å‡ºå¼‚å¸¸ <strong>JSON</strong> å“åº”ä½“çš„ä»£ç ã€‚</p>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HttpException</span>, <span class="hljs-title class_">HttpStatus</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ForbiddenException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">HttpException</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>, error?: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-variable language_">super</span>(
      {
        <span class="hljs-attr">status</span>: <span class="hljs-title class_">HttpStatus</span>.<span class="hljs-property">FORBIDDEN</span>,
        <span class="hljs-attr">error</span>: message,
      },
      <span class="hljs-title class_">HttpStatus</span>.<span class="hljs-property">FORBIDDEN</span>,
      {
        <span class="hljs-attr">cause</span>: error,
      }
    );
  }
}
</code></pre>
<p>åœ¨ <code>findAll</code> å‡½æ•°å°†æŠ›å‡ºæ ‡å‡†å¼‚å¸¸æ”¹ä¸ºè‡ªå®šä¹‰çš„ <code>ForbiddenException</code> å¼‚å¸¸ï¼š</p>
<pre><code class="language-tsx"><span class="hljs-meta">@Get</span>()
<span class="hljs-keyword">async</span> <span class="hljs-title function_">findAll</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ordersService</span>.<span class="hljs-title function_">findAll</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ForbiddenException</span>(<span class="hljs-string">&#x27;This is a custom message&#x27;</span>, error);
  }
}
</code></pre>
<h3><a id="å†…ç½®-http-å¼‚å¸¸" class="content__heading-anchor"></a>å†…ç½® HTTP å¼‚å¸¸</h3>
<p>ä¸‹é¢è¿™äº›æ˜¯ <strong>NestJS</strong> å†…ç½®çš„ <strong>HTTP</strong> å¼‚å¸¸ç±»ï¼Œå®ƒä»¬ä¸ä¸Šé¢è‡ªå®šä¹‰å¼‚å¸¸ä¸€æ ·éƒ½æ˜¯ç»§æ‰¿è‡ª<strong>HttpException</strong>ã€‚</p>
<ul>
<li><code>BadRequestException</code></li>
<li><code>UnauthorizedException</code></li>
<li><code>NotFoundException</code></li>
<li><code>ForbiddenException</code></li>
<li><code>NotAcceptableException</code></li>
<li><code>RequestTimeoutException</code></li>
<li><code>ConflictException</code></li>
<li><code>GoneException</code></li>
<li><code>HttpVersionNotSupportedException</code></li>
<li><code>PayloadTooLargeException</code></li>
<li><code>UnsupportedMediaTypeException</code></li>
<li><code>UnprocessableEntityException</code></li>
<li><code>InternalServerErrorException</code></li>
<li><code>NotImplementedException</code></li>
<li><code>ImATeapotException</code></li>
<li><code>MethodNotAllowedException</code></li>
<li><code>BadGatewayException</code></li>
<li><code>ServiceUnavailableException</code></li>
<li><code>GatewayTimeoutException</code></li>
<li><code>PreconditionFailedException</code></li>
</ul>
<h3><a id="åˆ›å»º-http-å¼‚å¸¸è¿‡æ»¤å™¨" class="content__heading-anchor"></a>åˆ›å»º HTTP å¼‚å¸¸è¿‡æ»¤å™¨</h3>
<p>åˆ›å»ºå¼‚å¸¸è¿‡æ»¤å™¨æ¥æ¥ç®¡å†…ç½®çš„ <strong>å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨</strong> å®ç°ä½¿ç”¨ä¸åŒé¡¹ç›®çš„å¼‚å¸¸æ•è·å¤„ç†ï¼Œå¦‚å¢åŠ å¼‚å¸¸çš„æ—¥å¿—è®°å½•æˆ–æ”¹å˜ <strong>JSON</strong> æ¨¡å¼ã€‚</p>
<ol>
<li>åˆ›å»ºè¿‡æ»¤å™¨ï¼š
<ul>
<li>å…¨å±€å‘½ä»¤ï¼š<code>nest generate filter &lt;filter-name&gt;</code></li>
<li>ç®€å†™å‘½ä»¤ï¼š<code>nest g f &lt;filter-name&gt;</code></li>
</ul></li>
</ol>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArgumentsHost</span>, <span class="hljs-title class_">Catch</span>, <span class="hljs-title class_">ExceptionFilter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;

<span class="hljs-meta">@Catch</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpExceptionFilter</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExceptionFilter</span> {
  <span class="hljs-keyword">catch</span>(<span class="hljs-attr">exception</span>: T, <span class="hljs-attr">host</span>: <span class="hljs-title class_">ArgumentsHost</span>) {}
}
</code></pre>
<ol>
<li>é€šè¿‡<code>@Catch()</code> æŒ‡å®šé»˜è®¤åˆ›å»ºçš„è¿‡æ»¤å™¨ä¸ºæŒ‡å®šçš„ <code>HttpException</code> è¿‡æ»¤å™¨ï¼š</li>
</ol>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">ArgumentsHost</span>,
  <span class="hljs-title class_">Catch</span>,
  <span class="hljs-title class_">ExceptionFilter</span>,
  <span class="hljs-title class_">HttpException</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;

<span class="hljs-meta">@Catch</span>(<span class="hljs-title class_">HttpException</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpExceptionFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExceptionFilter</span> {
  <span class="hljs-keyword">catch</span>(<span class="hljs-attr">exception</span>: <span class="hljs-title class_">HttpException</span>, <span class="hljs-attr">host</span>: <span class="hljs-title class_">ArgumentsHost</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(exception, host);
  }
}
</code></pre>
<p>é€šè¿‡æ‰§è¡Œä¸Šä¸‹æ–‡å¯¹è±¡(<code>host</code>)ä¸­çš„ <strong>request</strong> è·å–å½“å‰è¯·æ±‚çš„åœ°å€ï¼Œå¼‚å¸¸å¯¹è±¡(<code>exception</code>)è·å–å½“å‰å¼‚å¸¸çŠ¶æ€ç ï¼Œå¹¶æ‰§è¡Œä¸Šä¸‹æ–‡å¯¹è±¡(<code>host</code>)ä¸­é‡æ„ <strong>response</strong> å“åº”æ ¼å¼ï¼Œå®Œæˆå“åº”é‡æ„ï¼š</p>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">ArgumentsHost</span>,
  <span class="hljs-title class_">Catch</span>,
  <span class="hljs-title class_">ExceptionFilter</span>,
  <span class="hljs-title class_">HttpException</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;

<span class="hljs-meta">@Catch</span>(<span class="hljs-title class_">HttpException</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpExceptionFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExceptionFilter</span> {
  <span class="hljs-keyword">catch</span>(<span class="hljs-attr">exception</span>: <span class="hljs-title class_">HttpException</span>, <span class="hljs-attr">host</span>: <span class="hljs-title class_">ArgumentsHost</span>) {
    <span class="hljs-keyword">const</span> ctx = host.<span class="hljs-title function_">switchToHttp</span>();
    <span class="hljs-keyword">const</span> request = ctx.<span class="hljs-title function_">getRequest</span>();
    <span class="hljs-keyword">const</span> response = ctx.<span class="hljs-title function_">getResponse</span>();
    <span class="hljs-keyword">const</span> status = exception.<span class="hljs-title function_">getStatus</span>();

    response.<span class="hljs-title function_">status</span>(status).<span class="hljs-title function_">json</span>({
      <span class="hljs-attr">statusCode</span>: status,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
      <span class="hljs-attr">path</span>: request.<span class="hljs-property">url</span>,
    });
  }
}
</code></pre>
<p>ğŸ’¡  å°ç»“ï¼š</p>
<ol>
<li><code>exception</code> ä¸ºå½“å‰æ•è·åˆ°çš„å¼‚å¸¸å¯¹è±¡ï¼›</li>
<li><code>host</code> æ˜¯å½“å‰çš„æ‰§è¡Œä¸Šä¸‹æ–‡å¯¹è±¡ï¼›</li>
</ol>
<h3><a id="ç»‘å®šè¿‡æ»¤å™¨" class="content__heading-anchor"></a>ç»‘å®šè¿‡æ»¤å™¨</h3>
<p>è·¯ç”±æ‰§è¡Œå‡½æ•°èŒƒå›´ç»‘å®šï¼š</p>
<pre><code class="language-tsx"><span class="hljs-meta">@Get</span>()
<span class="hljs-meta">@UseFilters</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpExceptionFilter</span>())
<span class="hljs-keyword">async</span> <span class="hljs-title function_">findAll</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ordersService</span>.<span class="hljs-title function_">findAll</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ForbiddenException</span>(<span class="hljs-string">&#x27;This is a custom message&#x27;</span>, error);
  }
}

<span class="hljs-comment">// or</span>

<span class="hljs-meta">@Get</span>()
<span class="hljs-meta">@UseFilters</span>(<span class="hljs-title class_">HttpExceptionFilter</span>)
<span class="hljs-keyword">async</span> <span class="hljs-title function_">findAll</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ordersService</span>.<span class="hljs-title function_">findAll</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ForbiddenException</span>(<span class="hljs-string">&#x27;This is a custom message&#x27;</span>, error);
  }
}
</code></pre>
<p>æ§åˆ¶å™¨èŒƒå›´ç»‘å®šï¼š</p>
<pre><code class="language-tsx"><span class="hljs-meta">@UseFilters</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpExceptionFilter</span>())
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrdersController</span> {}

<span class="hljs-comment">// or</span>

<span class="hljs-meta">@UseFilters</span>(<span class="hljs-title class_">HttpExceptionFilter</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrdersController</span> {}
</code></pre>
<p>å…¨å±€èŒƒå›´ç»‘å®šï¼š</p>
<pre><code class="language-tsx"><span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>);
app.<span class="hljs-title function_">useGlobalFilters</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpExceptionFilter</span>());

<span class="hljs-comment">// or</span>

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">providers</span>: [
    {
      <span class="hljs-attr">provide</span>: <span class="hljs-variable constant_">APP_FILTER</span>,
      <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">HttpExceptionFilter</span>,
    },
  ],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}
</code></pre>
<h3><a id="åˆ›å»ºé€šç”¨å¼‚å¸¸è¿‡æ»¤å™¨" class="content__heading-anchor"></a>åˆ›å»ºé€šç”¨å¼‚å¸¸è¿‡æ»¤å™¨</h3>
<p>åœ¨åˆ›å»º <strong>HTTP</strong> å¼‚å¸¸è¿‡æ»¤å™¨çš„æ—¶å€™ä½¿ç”¨ <code>@Catch()</code> è£…é¥°å™¨ç»‘å®šäº†ç‰¹å®šçš„ <code>HttpException</code>ï¼Œæ¥ä¸‹æ¥å°±åˆ›å»ºä¸€ä¸ªè„±ç¦»ç‰¹å®šå¼‚å¸¸ç±»ä¸”ä¸å¹³å°æ— å…³çš„é€šç”¨å¼‚å¸¸è¿‡æ»¤å™¨ã€‚</p>
<pre><code class="language-tsx"><span class="hljs-comment">// create commandï¼š`nest g f all-exceptions`</span>
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">ArgumentsHost</span>,
  <span class="hljs-title class_">Catch</span>,
  <span class="hljs-title class_">ExceptionFilter</span>,
  <span class="hljs-title class_">HttpException</span>,
  <span class="hljs-title class_">HttpStatus</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HttpAdapterHost</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/core&quot;</span>;

<span class="hljs-meta">@Catch</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AllExceptionsFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExceptionFilter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">httpAdapterHost</span>: <span class="hljs-title class_">HttpAdapterHost</span></span>) {}

  <span class="hljs-keyword">catch</span>(<span class="hljs-attr">exception</span>: <span class="hljs-built_in">unknown</span>, <span class="hljs-attr">host</span>: <span class="hljs-title class_">ArgumentsHost</span>) {
    <span class="hljs-keyword">const</span> { httpAdapter } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">httpAdapterHost</span>;

    <span class="hljs-keyword">const</span> ctx = host.<span class="hljs-title function_">switchToHttp</span>();

    <span class="hljs-keyword">const</span> httpStatus =
      exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HttpException</span>
        ? exception.<span class="hljs-title function_">getStatus</span>()
        : <span class="hljs-title class_">HttpStatus</span>.<span class="hljs-property">INTERNAL_SERVER_ERROR</span>;

    <span class="hljs-keyword">const</span> responseBody = {
      <span class="hljs-attr">statusCode</span>: httpStatus,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
      <span class="hljs-attr">path</span>: httpAdapter.<span class="hljs-title function_">getRequestUrl</span>(ctx.<span class="hljs-title function_">getRequest</span>()),
    };

    httpAdapter.<span class="hljs-title function_">reply</span>(ctx.<span class="hljs-title function_">getResponse</span>(), responseBody, httpStatus);
  }
}
</code></pre>
<p>ç»‘å®šé€šç”¨å¼‚å¸¸è¿‡æ»¤å™¨ï¼š</p>
<pre><code class="language-tsx"><span class="hljs-keyword">const</span> { httpAdapter } = app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">HttpAdapterHost</span>);
app.<span class="hljs-title function_">useGlobalFilters</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AllExceptionsFilter</span>(httpAdapter));
</code></pre>
<h2><a id="ç®¡é“çš„ä½¿ç”¨" class="content__heading-anchor"></a>ç®¡é“çš„ä½¿ç”¨</h2>
<p>ç®¡é“æœ‰ä¸¤ä¸ªå…¸å‹çš„åº”ç”¨åœºæ™¯ï¼Œå…¶ä¸€æ˜¯è½¬æ¢(å°†è¾“å…¥æ•°æ®è½¬æ¢ä¸ºæ‰€éœ€è¦çš„å½¢å¼ï¼Œå¦‚ï¼Œå°†å­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—ç±»å‹)ï¼Œå…¶äºŒæ˜¯æ ¡éªŒ(æ ¡éªŒä¼ å…¥æ•°æ®æ˜¯å¦æœ‰æ•ˆï¼Œæ— æ•ˆæ—¶å°†æŠ›å‡ºå¼‚å¸¸)æ•°æ®æ˜¯å¦æœ‰æ•ˆã€‚å› æ­¤ç®¡é“å°†è¿è¡Œåœ¨è·¯ç”±å¤„ç†å‡½æ•°çš„ <code>arguments</code> ä¸Šã€‚</p>
<h3><a id="ç»‘å®šç®¡é“" class="content__heading-anchor"></a>ç»‘å®šç®¡é“</h3>
<p>NestJs æä¾›äº† 9 ä¸ªå¼€ç®±å³ç”¨çš„å†…ç½®ç®¡é“(<code>ValidationPipe</code>ï¼Œ<code>ParseIntPipe</code>ï¼Œ<code>ParseFloatPipe</code>ï¼Œ<code>ParseBoolPipe</code>ï¼Œ<code>ParseArrayPipe</code>ï¼Œ<code>ParseUUIDPipe</code>ï¼Œ<code>ParseEnumPipe</code>ï¼Œ<code>DefaultValuePipe</code>ï¼Œ<code>ParseFilePipe</code>)ï¼Œæ¥ç€å°±å°è¯•ç»‘å®š <code>ParseIntPipe</code> åˆ° <code>findOne</code> å¤„ç†å‡½æ•° å‡½æ•°ï¼Œè· <strong>number</strong> ç±»å‹ çš„ <code>id</code> å‚æ•°ï¼š</p>
<pre><code class="language-tsx"><span class="hljs-meta">@Get</span>(<span class="hljs-string">&#x27;:id&#x27;</span>)
<span class="hljs-title function_">findOne</span>(<span class="hljs-params"><span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;id&#x27;</span>, ParseIntPipe) <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> id); <span class="hljs-comment">// number</span>
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ordersService</span>.<span class="hljs-title function_">findOne</span>(id);
}
</code></pre>
<p>å¦‚æœä¼ é€’çš„å‚æ•°æ— æ³•è½¬æ¢ä¸ºæ•°å­—åˆ™æŠ›å‡ºå¦‚ä¸‹çš„å¼‚å¸¸ï¼š</p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;statusCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">400</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2023-12-09T14:42:20.014Z&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/orders/a&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>é€šè¿‡å®ä¾‹åŒ– <code>ParseIntPipe</code> å¯¹è±¡å®šä¹‰è½¬æ¢å¤±è´¥åçš„é”™è¯¯ç ï¼š</p>
<pre><code class="language-tsx"><span class="hljs-meta">@Get</span>(<span class="hljs-string">&#x27;:id&#x27;</span>)
  <span class="hljs-title function_">findOne</span>(<span class="hljs-params">
    <span class="hljs-meta">@Param</span>(
      <span class="hljs-string">&#x27;id&#x27;</span>,
      <span class="hljs-keyword">new</span> ParseIntPipe({
        errorHttpStatusCode: HttpStatus.NOT_ACCEPTABLE,
      }),
    )
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>,
  </span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> id); <span class="hljs-comment">// number</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ordersService</span>.<span class="hljs-title function_">findOne</span>(id);
  }
</code></pre>
<h3><a id="åŸºäº-schema-çš„éªŒè¯" class="content__heading-anchor"></a>åŸºäº schema çš„éªŒè¯</h3>
<p><strong>zod</strong> æ˜¯ç”¨æ¥å®šä¹‰ <strong>schema</strong> å’Œ è¿›è¡ŒéªŒè¯çš„æ¨¡å—ï¼ŒåŸºäºç®¡é“å¯ä»¥å¾ˆå¥½çš„æ—¶é—´è·¯ç”±å¤„ç†å‡½æ•°å‚æ•°çš„éªŒè¯ï¼š</p>
<ol>
<li>å®‰è£… <strong>zod</strong>ï¼š<code>npm install --save zod</code> ï¼›</li>
<li>åˆ›å»ºç®¡é“ï¼š<code>nest generate pipe zod-validation</code> or <code>nest g pi zod-validation</code>ï¼›</li>
<li>å®Œå–„ç®¡é“ï¼šåˆ©ç”¨æ³¨å…¥çš„<code>ZodObject</code> è§£æå‚æ•°æ•°æ®æ ¼å¼ï¼›</li>
</ol>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">ArgumentMetadata</span>,
  <span class="hljs-title class_">BadRequestException</span>,
  <span class="hljs-title class_">Injectable</span>,
  <span class="hljs-title class_">PipeTransform</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ZodObject</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;zod&quot;</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZodValidationPipe</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PipeTransform</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-attr">schema</span>: <span class="hljs-title class_">ZodObject</span>&lt;<span class="hljs-built_in">any</span>&gt;</span>) {}

  <span class="hljs-title function_">transform</span>(<span class="hljs-params"><span class="hljs-attr">value</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">metadata</span>: <span class="hljs-title class_">ArgumentMetadata</span></span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">schema</span>.<span class="hljs-title function_">parse</span>(value);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadRequestException</span>(<span class="hljs-string">&quot;Validation failed&quot;</span>);
    }
    <span class="hljs-keyword">return</span> value;
  }
}
</code></pre>
<ol>
<li>å®šä¹‰ schemaï¼š</li>
</ol>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;zod&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> createOrderSchema = z
  .<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">orderId</span>: z.<span class="hljs-title function_">string</span>(),
    <span class="hljs-attr">orderNo</span>: z.<span class="hljs-title function_">string</span>(),
    <span class="hljs-attr">orderName</span>: z.<span class="hljs-title function_">string</span>(),
    <span class="hljs-attr">orderStatus</span>: z.<span class="hljs-title function_">string</span>(),
    <span class="hljs-attr">orderAmount</span>: z.<span class="hljs-title function_">number</span>(),
    <span class="hljs-attr">createTime</span>: z.<span class="hljs-title function_">date</span>(),
    <span class="hljs-attr">updateTime</span>: z.<span class="hljs-title function_">date</span>(),
  })
  .<span class="hljs-title function_">required</span>();

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">CreateOrderDto</span> = z.<span class="hljs-property">infer</span>&lt;<span class="hljs-keyword">typeof</span> createOrderSchema&gt;;
</code></pre>
<ol>
<li>ç»‘å®šç®¡é“ï¼š</li>
</ol>
<pre><code class="language-tsx"><span class="hljs-meta">@Post</span>()
<span class="hljs-meta">@UsePipes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ZodValidationPipe</span>(createOrderSchema))
<span class="hljs-title function_">create</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>() <span class="hljs-attr">createOrderDto</span>: <span class="hljs-title class_">CreateOrderDto</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ordersService</span>.<span class="hljs-title function_">create</span>(createOrderDto);
}
</code></pre>
<h3><a id="åŸºäº-class-çš„éªŒè¯" class="content__heading-anchor"></a>åŸºäº class çš„éªŒè¯</h3>
<p>åœ¨ <strong>NestJS</strong> ä¸­å¯ä»¥ä½¿ç”¨ <strong>class-validator</strong> æ¨¡å—å®ç°åŸºäºç±»å’Œè£…é¥°å™¨çš„å½¢å¼è¿›è¡Œå‚æ•°éªŒè¯ã€‚</p>
<ol>
<li>å®‰è£… <strong>class-validator</strong>ï¼š<code>npm i --save class-validator class-transformer</code> ;</li>
<li>åˆ›å»ºç®¡é“ï¼š<code>nest generate pipe validation</code> or <code>nest g pi validation</code>ï¼›</li>
<li>å®Œå–„ç®¡é“ï¼šåˆ©ç”¨ <code>metatype</code> æä¾›çš„å‚æ•°å…ƒç±»å‹éªŒè¯å‚æ•°ï¼›</li>
</ol>
<pre><code class="language-tsx"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">ArgumentMetadata</span>,
  <span class="hljs-title class_">BadRequestException</span>,
  <span class="hljs-title class_">Injectable</span>,
  <span class="hljs-title class_">PipeTransform</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@nestjs/common&quot;</span>;
<span class="hljs-keyword">import</span> { validate } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;class-validator&quot;</span>;
<span class="hljs-keyword">import</span> { plainToInstance } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;class-transformer&quot;</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ValidationPipe</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PipeTransform</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params"><span class="hljs-attr">value</span>: <span class="hljs-built_in">any</span>, { metatype }: <span class="hljs-title class_">ArgumentMetadata</span></span>) {
    <span class="hljs-keyword">if</span> (!metatype || !<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toValidate</span>(metatype)) {
      <span class="hljs-keyword">return</span> value;
    }
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">object</span> = <span class="hljs-title function_">plainToInstance</span>(metatype, value);
    <span class="hljs-keyword">const</span> errors = <span class="hljs-keyword">await</span> <span class="hljs-title function_">validate</span>(<span class="hljs-built_in">object</span>);
    <span class="hljs-keyword">if</span> (errors.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadRequestException</span>(<span class="hljs-string">&quot;Validation failed&quot;</span>);
    }
    <span class="hljs-keyword">return</span> value;
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">toValidate</span>(<span class="hljs-attr">metatype</span>: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">types</span>: <span class="hljs-built_in">any</span>[] = [<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Number</span>, <span class="hljs-title class_">Date</span>];
    <span class="hljs-keyword">return</span> !types.<span class="hljs-title function_">includes</span>(metatype);
  }
}
</code></pre>
<ol>
<li>é‡æ–°ç»‘å®šç®¡é“ï¼š</li>
</ol>
<pre><code class="language-tsx"><span class="hljs-meta">@Post</span>()
<span class="hljs-title function_">create</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>(<span class="hljs-keyword">new</span> ValidationPipe()) <span class="hljs-attr">createOrderDto</span>: <span class="hljs-title class_">CreateOrderDto</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ordersService</span>.<span class="hljs-title function_">create</span>(createOrderDto);
}
</code></pre>
<p>ğŸ’¡ å…¨å±€ç»‘å®šç®¡é“ï¼š</p>
<pre><code class="language-tsx"><span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>);
app.<span class="hljs-title function_">useGlobalPipes</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationPipe</span>());

<span class="hljs-comment">// or</span>

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">providers</span>: [
    {
      <span class="hljs-attr">provide</span>: <span class="hljs-variable constant_">APP_PIPE</span>,
      <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">ValidationPipe</span>,
    },
  ],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}
</code></pre>
<h2><a id="æ€»ç»“" class="content__heading-anchor"></a>æ€»ç»“</h2>
<p>æœ¬ç¯‡æ–‡ç« ä»‹ç»äº† Nestjs çš„ä½¿ç”¨ï¼ŒåŒ…æ‹¬åˆ›å»ºé¡¹ç›®å’Œæ¨¡å—ï¼Œæ§åˆ¶å™¨ã€æœåŠ¡ã€æ¨¡å—ã€ä¸­é—´ä»¶ã€å¼‚å¸¸è¿‡æ»¤å™¨ã€ç®¡é“ã€å®ˆå«å’Œæ‹¦æˆªå™¨çš„ä½¿ç”¨ã€‚æ§åˆ¶å™¨å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼ŒæœåŠ¡å°è£…å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ¨¡å—ç®¡ç†æ‰€æœ‰æ§åˆ¶å™¨å’Œæä¾›è€…ï¼Œä¸­é—´ä»¶æ›´æ”¹è¯·æ±‚å“åº”å¯¹è±¡ï¼Œå¼‚å¸¸è¿‡æ»¤å™¨å¤„ç†æ‰€æœ‰æœªå¤„ç†çš„å¼‚å¸¸ï¼Œç®¡é“å¯¹å®¢æˆ·ç«¯æ•°æ®è¿›è¡Œè½¬æ¢å’ŒéªŒè¯ï¼Œå®ˆå«æ ¹æ®ç‰¹å®šçš„æƒé™è§’è‰²å†³å®šæ˜¯å¦è¿›è¡Œå¤„ç†ï¼Œæ‹¦æˆªå™¨å¯¹å¤„ç†å‡½æ•°è¿›è¡Œåˆ‡é¢ä¸Šçš„æ‰©å±•ã€‚</p>
 </article> </section> </main>  <footer class="footer"> <hr class="footer__divide"> <div class="footer__row"> <p class="m-2">
&#169; 2017-2024 <a href="/" class="link">9Sky ä¹å¤©</a> </p> <div class="m-2"> <ul data-astro-cid-tfcnbjmv> <li data-astro-cid-tfcnbjmv> <a class="link" href="/" data-astro-cid-tfcnbjmv> 
ä¸»é¡µ
</a> </li> <li data-astro-cid-tfcnbjmv> <a class="link" href="/blog" data-astro-cid-tfcnbjmv>  æ–‡ç«  </a> </li><li data-astro-cid-tfcnbjmv> <a class="link" href="/projects" data-astro-cid-tfcnbjmv>  é¡¹ç›® </a> </li><li data-astro-cid-tfcnbjmv> <a class="link" href="/lab" data-astro-cid-tfcnbjmv>  å®éªŒå®¤ </a> </li><li data-astro-cid-tfcnbjmv> <a class="link" href="/about" data-astro-cid-tfcnbjmv>  å…³äº </a> </li> </ul>  </div> </div> </footer> </body></html> 