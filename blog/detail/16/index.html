<!DOCTYPE html><html> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>Koa 源码分析&amp;手写 Koa</title><link rel="icon" type="image/vnd.microsoft.icon" href="/favicon.ico"><link rel="sitemap" href="/sitemap-index.xml"><title>Koa 源码分析&手写 Koa</title><link rel="canonical" href="https://wty9sky.github.io/blog/detail/16/"><meta name="description" content="Koa 源码分析&#38;手写 Koa"><meta name="robots" content="index, follow"><meta property="og:title" content="Koa 源码分析&#38;手写 Koa"><meta property="og:type" content="article"><meta property="og:image" content="/og.svg"><meta property="og:url" content="https://wty9sky.github.io/blog/detail/16/"><meta property="og:locale" content="zh_CN"><meta property="og:locale:alternate" content="zh_TW"><meta property="og:locale:alternate" content="en_US"><meta property="og:site_name" content="9Sky 九天"><link rel="shortcut icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/avatar.png"><meta name="generator" content="Astro v4.16.7"><meta name="keywords" content="详情"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><link rel="stylesheet" href="/_astro/about.CkC6PiIh.css">
<link rel="stylesheet" href="/_astro/about.D3zQv4Ly.css"><script type="module" src="/_astro/hoisted.HO6_Fzad.js"></script></head> <body> <header class="header"> <h5 class="header__heading"> <a href="/" class="link">9Sky 九天</a> <span>
/
<a href="/blog" class="link"> 博客 </a> </span><span>
/
Koa 源码分析&amp;手写 Koa </span> </h5> </header> <div id="navbar-sentinal"></div> <nav class="navbar" id="navbar-wrapper"> <div class="navbar__content"> <h5 class="navbar__path"> <a href="/" class="link">9Sky 九天</a> <span>
/
<a href="/blog" class="link"> 博客 </a> </span><span>
/
Koa 源码分析&amp;手写 Koa </span> </h5> <div class="navbar__menu"> <ul data-astro-cid-tfcnbjmv> <li data-astro-cid-tfcnbjmv> <a class="link" href="/" data-astro-cid-tfcnbjmv> <i class="ri-home-line" data-astro-cid-tfcnbjmv></i>
主页
</a> </li> <li data-astro-cid-tfcnbjmv> <a class="link" href="/blog" data-astro-cid-tfcnbjmv> <i class="ri-newspaper-line" data-astro-cid-tfcnbjmv></i> 文章 </a> </li><li data-astro-cid-tfcnbjmv> <a class="link" href="/projects" data-astro-cid-tfcnbjmv> <i class="ri-server-line" data-astro-cid-tfcnbjmv></i> 项目 </a> </li><li data-astro-cid-tfcnbjmv> <a class="link" href="/lab" data-astro-cid-tfcnbjmv> <i class="ri-server-line" data-astro-cid-tfcnbjmv></i> 实验室 </a> </li><li data-astro-cid-tfcnbjmv> <a class="link" href="/about" data-astro-cid-tfcnbjmv> <i class="ri-cup-line" data-astro-cid-tfcnbjmv></i> 关于 </a> </li> </ul>  </div> </div> </nav> <script>
  // 使用 ViewTransition 后，所有 DOM 操作的 js 都有一堆问题
  // 这里用了极不优雅的 var，有待改进
  var observer;
  function addNavObserver() {
    const headerEl = document.querySelector("#navbar-wrapper");
    const sentinalEl = document.querySelector("#navbar-sentinal");
    if (!sentinalEl || !headerEl) return;
    observer = new window.IntersectionObserver((e) => {
      if (!e[0].isIntersectin && e[0].boundingClientRect.top <= 0) {
        headerEl.classList.add("navbar--sticked");
      } else {
        headerEl.classList.remove("navbar--sticked");
      }
    });
    observer.observe(sentinalEl);
  }

  function removeNavObserver() {
    if (observer) observer.disconnect();
    observer = null;
  }

  document.addEventListener(
    "astro:page-load",
    () => {
      addNavObserver();
    },
    { once: false },
  );

  document.addEventListener(
    "astro:before-swap",
    () => {
      removeNavObserver();
    },
    { once: false },
  );
</script>  <main class="page"> <section class="page__section page__section--at-top"> <!-- {
        article.cover && (
          <a href={article.cover} data-fancybox data-caption={article.title}>
            <img
              src={article.cover}
              alt={article.title}
              title={article.title}
              class="page__cover mb-8"
            />
          </a>
        )
      } --> <h1 class="page__heading">Koa 源码分析&amp;手写 Koa</h1> <p class="page__meta"> <i class="ri-calendar-line"></i> <span>2023 年 2 月 21 日 10:20</span> </p> <hr class="page__divide"> <article class="content"> <h2><a id="文章目录" class="content__heading-anchor"></a>文章目录</h2>
<ul>
<li><a href="#koa-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E6%89%8B%E5%86%99-koa">Koa 源码分析&amp;手写 Koa</a>
<ul>
<li><a href="#%E5%90%AF%E5%8A%A8-koa-%E6%9C%8D%E5%8A%A1">启动 Koa 服务</a></li>
<li><a href="#%E6%B4%8B%E8%91%B1%E6%A8%A1%E5%9E%8B">洋葱模型</a>
<ul>
<li><a href="#%E5%8D%95%E4%B8%AA%E4%B8%AD%E9%97%B4%E4%BB%B6">单个中间件</a></li>
<li><a href="#%E5%A4%9A%E4%B8%AA%E4%B8%AD%E9%97%B4%E4%BB%B6">多个中间件</a></li>
<li><a href="#%E8%BE%B9%E7%95%8C">边界</a></li>
<li><a href="#%E5%BC%82%E6%AD%A5">异步</a></li>
<li><a href="#promiseresolve">Promise.resolve</a></li>
<li><a href="#ctx-%E5%B0%81%E8%A3%85">ctx 封装</a>
<ul>
<li><a href="#%E5%9F%BA%E7%A1%80%E7%BB%93%E6%9E%84">基础结构</a></li>
</ul></li>
<li><a href="#response--request">response &amp; request</a></li>
<li><a href="#ctx-%E5%88%AB%E5%90%8D">ctx 别名</a>
<ul>
<li><a href="#ctxbody">ctx.body</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<h1><a id="koa-源码分析手写-koa" class="content__heading-anchor"></a>Koa 源码分析&amp;手写 Koa</h1>
<h2><a id="启动-koa-服务" class="content__heading-anchor"></a>启动 Koa 服务</h2>
<p>Koa 的最简 demo</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;koa&quot;</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>(); <span class="hljs-comment">//new 操作符，那么 koa 抛出的肯定是一个构造函数（function）或者类（class）</span>
app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8889</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">//Koa 实例调用了 listen 方法，并且接收了几个参数，如果先不管参数，那么 Koa 实例内肯定包含一个 listen 方法</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`启动成功8889`</span>);
});
</code></pre>
<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Koa</span> {
  <span class="hljs-title function_">listen</span>(<span class="hljs-params">...args</span>) {}
}
</code></pre>
<p>启动成功后会调起一个服务</p>
<ul>
<li>node 的 http 模块的 createServer
<ul>
<li>createServer 得到一个 server 后也拥有一个 listen 方法，并且完全对应 demo 里 app.listen 的参数</li>
</ul></li>
</ul>
<p>Koa 的 listen 实现如下</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;http&quot;</span>);
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Koa</span> {
  <span class="hljs-title function_">listen</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>();
    <span class="hljs-keyword">return</span> server.<span class="hljs-title function_">listen</span>(...args);
  }
}
</code></pre>
<p>验证一下</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./listen.js&quot;</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();
app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8889</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`启动成功8889`</span>);
});
</code></pre>
<h2><a id="洋葱模型" class="content__heading-anchor"></a>洋葱模型</h2>
<h3><a id="单个中间件" class="content__heading-anchor"></a>单个中间件</h3>
<p>单个中间件的最简 demo</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;koa&quot;</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">//可以推断出Koa类有一个use函数，并且接收一个函数参数</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8889</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`启动成功8889`</span>);
});
</code></pre>
<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Koa</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {
    <span class="hljs-comment">// 初始化函数</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span> = <span class="hljs-function">() =&gt;</span> {}
  }
  <span class="hljs-title function_">use</span>(<span class="hljs-params">cb</span>) {
    <span class="hljs-comment">// 保存函数</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span> = cb
  },
  <span class="hljs-title function_">listen</span>(<span class="hljs-params">...</span>) {...}
}
</code></pre>
<p>可以假设 app.use 是一个注册器，注册了一个函数（中间件），当服务接收到请求后执行这个函数，而 http.createServer api 的参数接收一个函数来监听请求，正好满足我们的需求。</p>
<pre><code class="language-javascript"><span class="hljs-comment">// 源码层</span>
<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;http&quot;</span>);
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Koa</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {
    <span class="hljs-comment">// 初始化函数</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span> = <span class="hljs-function">() =&gt;</span> {};
  }
  <span class="hljs-comment">// 一个注册器</span>
  <span class="hljs-title function_">use</span>(<span class="hljs-params">cb</span>) {
    <span class="hljs-comment">// 保存函数</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span> = cb;
  }
  <span class="hljs-title function_">listen</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-comment">// http.createServer接收一个函数参数，用于接收请求</span>
    <span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
      <span class="hljs-comment">// 接收到请求后执行use中注册的函数</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">middleware</span>();
      <span class="hljs-comment">// 这一段是为了正常结束请求，暂时加上，可以先忽略</span>
      res.<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;1&quot;</span>);
    });
    <span class="hljs-keyword">return</span> server.<span class="hljs-title function_">listen</span>(...args);
  }
}
</code></pre>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./use.js&quot;</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);
});
app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8889</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`启动成功8889`</span>);
});
</code></pre>
<h3><a id="多个中间件" class="content__heading-anchor"></a>多个中间件</h3>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;koa&quot;</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();
app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">cb1</span>(<span class="hljs-params">ctx, next</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">next</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">5</span>);
});

app
  .<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">cb2</span>(<span class="hljs-params">ctx, next</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
    <span class="hljs-title function_">next</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">4</span>);
  })
  .<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">cb3</span>(<span class="hljs-params">ctx, next</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
  });

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8889</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`启动成功8889`</span>);
});
</code></pre>
<p>多次使用 app.use 注册中间件，中间件接收 ctx，next 两个参数，因为可以注册多个，需要用有一个地方存起来，比如用数组存储,可以推断出 use 内返回 this,next()会暂停执行当前中间件去执行下一个中间件，实际上就像 js 内的嵌套函数。</p>
<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Koa</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {
    <span class="hljs-comment">// 老代码 this.middleware = () =&gt; {}</span>
    <span class="hljs-comment">// 保存中间件数组</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span> = [];
  }
  <span class="hljs-comment">// 注册器</span>
  <span class="hljs-title function_">use</span>(<span class="hljs-params">cb</span>) {
    <span class="hljs-comment">// 保存中间件</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span>.<span class="hljs-title function_">push</span>(cb);
    <span class="hljs-comment">// 链式写法</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
}
</code></pre>
<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">cb1</span>(<span class="hljs-params">next</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">next</span>(cb3);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">5</span>);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">cb2</span>(<span class="hljs-params">next</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
  <span class="hljs-title function_">next</span>(cb3);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">4</span>);
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">cb3</span>(<span class="hljs-params">next</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
}
<span class="hljs-title function_">cb1</span>(cb2);
<span class="hljs-comment">// 放控制台执行 -&gt; 1 2 3 4 5</span>
<span class="hljs-comment">// cb1的next -&gt; cb2</span>
<span class="hljs-comment">// cb2的next -&gt; cb3</span>
<span class="hljs-comment">// cb3的next -&gt; () =&gt; {} // 兼容</span>
</code></pre>
<p>封装 use 函数</p>
<ul>
<li>中间件注册的时机
<ul>
<li>中间件的注册发生在 node 服务启动的时候</li>
<li>执行是在请求进来时，所以请求进来的时候</li>
<li>我们已经用数组保存了全部的中间件</li>
</ul></li>
</ul>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> middleware = [cb1, cb2, cb3];
<span class="hljs-comment">// 执行cb1的时候，我们可以获取到cb2，并传给cb1</span>
middleware[<span class="hljs-number">0</span>](middleware[<span class="hljs-number">1</span>]);
</code></pre>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;http&quot;</span>);
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Koa</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {
    <span class="hljs-comment">// 初始化中间件数组，因为可能是多个</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span> = [];
  }
  <span class="hljs-comment">// 注册器</span>
  <span class="hljs-title function_">use</span>(<span class="hljs-params">cb</span>) {
    <span class="hljs-comment">// 保存所有注册的中间件</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span>.<span class="hljs-title function_">push</span>(cb);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
  <span class="hljs-title function_">compose</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">dispatch</span> = (<span class="hljs-params">i</span>) =&gt; {
      <span class="hljs-comment">// 从数组中取出中间件</span>
      <span class="hljs-keyword">const</span> fn = <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span>[i];
      <span class="hljs-comment">// 执行中间件，并传递执行下一个中间件的函数</span>
      <span class="hljs-comment">// dispatch(i + 1)会立即执行下一个中间件，所以用一个函数包起来，何时执行交给用户自己选择</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">dispatch</span>(i + <span class="hljs-number">1</span>));
    };
    <span class="hljs-comment">// 执行第一个中间件</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-number">0</span>);
  }
  <span class="hljs-title function_">callback</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
      <span class="hljs-comment">// 接收请求后执行compose</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compose</span>();
      <span class="hljs-comment">// 这一段是为了让Postman正常结束请求，暂时加上，可以先忽略</span>
      res.<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;111&quot;</span>);
    };
  }
  <span class="hljs-title function_">listen</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callback</span>());
    <span class="hljs-keyword">return</span> server.<span class="hljs-title function_">listen</span>(...args);
  }
}
</code></pre>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./useSync.js&quot;</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();
app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">cb1</span>(<span class="hljs-params">next</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">next</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">5</span>);
});

app
  .<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">cb2</span>(<span class="hljs-params">next</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
    <span class="hljs-title function_">next</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">4</span>);
  })
  .<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">cb3</span>(<span class="hljs-params">next</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
  });

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8889</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`启动成功8889`</span>);
});
</code></pre>
<p>middleware 是一个数组<br>
middleware 内每一项都是一个函数，为了代码更健壮，最好在启动阶段就进行强制校验。</p>
<p>运行时机：启动时，也就是执行 callback 的时候<br>
需要 compose 提供的功能：校验 + 执行中间件。利用闭包，执行时校验并返回一个执行中间件的函数，callback 执行时立即执行 compose，请求进来时执行中间件函数</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;http&quot;</span>);
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Koa</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span> = [];
  }
  <span class="hljs-title function_">use</span>(<span class="hljs-params">cb</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span>.<span class="hljs-title function_">push</span>(cb);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
  <span class="hljs-title function_">compose</span>(<span class="hljs-params">middleware</span>) {
    <span class="hljs-comment">// 校验中间件是数组</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(middleware))
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&quot;Middleware stack must be an array!&quot;</span>);
    <span class="hljs-comment">// 校验每一项是函数</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> fn <span class="hljs-keyword">of</span> middleware) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fn !== <span class="hljs-string">&quot;function&quot;</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&quot;Middleware must be composed of functions!&quot;</span>);
    }
    <span class="hljs-comment">// 返回执行中间件的函数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">dispatch</span> = (<span class="hljs-params">i</span>) =&gt; {
        <span class="hljs-comment">// 从数组中取出中间件</span>
        <span class="hljs-keyword">const</span> fn = middleware[i];
        <span class="hljs-comment">// 执行中间件，并传递执行下一个中间件的函数</span>
        <span class="hljs-comment">// 这里注意，dispatch(i + 1)会立即执行下一个中间件，所以用一个函数包起来，何时执行交给用户自己选择</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">dispatch</span>(i + <span class="hljs-number">1</span>));
      };
      <span class="hljs-comment">// 执行第一个中间件</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-number">0</span>);
    };
  }
  <span class="hljs-title function_">callback</span>(<span class="hljs-params"></span>) {
    <span class="hljs-comment">// 启动时校验</span>
    <span class="hljs-keyword">const</span> fn = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compose</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
      <span class="hljs-comment">// 请求进来时执行</span>
      <span class="hljs-title function_">fn</span>();
      res.<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;111&quot;</span>);
    };
  }
  <span class="hljs-title function_">listen</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callback</span>());
    <span class="hljs-keyword">return</span> server.<span class="hljs-title function_">listen</span>(...args);
  }
}
</code></pre>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./useSyncValidator.js&quot;</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();
app.<span class="hljs-title function_">use</span>(<span class="hljs-number">111</span>);

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8889</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`启动成功8889`</span>);
});
</code></pre>
<h3><a id="边界" class="content__heading-anchor"></a>边界</h3>
<p>Koa 的边界情况：</p>
<ul>
<li>Koa 中规定每个中间件只能执行一次 next</li>
<li>最后一个中间件也存在 next，执行 next 会报错。因为 i &gt;= middleware.length，用 middleware[i]获取到的是 undefined</li>
</ul>
<pre><code class="language-javascript"><span class="hljs-title function_">compose</span>(<span class="hljs-params">middleware</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(middleware)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;Middleware stack must be an array!&#x27;</span>)
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> fn <span class="hljs-keyword">of</span> middleware) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fn !== <span class="hljs-string">&#x27;function&#x27;</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;Middleware must be composed of functions!&#x27;</span>)
  }
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">dispatch</span> = (<span class="hljs-params">i</span>) =&gt; {
      <span class="hljs-keyword">const</span> fn = middleware[i]
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">dispatch</span>(i + <span class="hljs-number">1</span>))
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-number">0</span>)
  }
}
</code></pre>
<p>每一个 next 都是一个 dispatch(i + 1)，也就是说每次执行 next 的时候 i 都是相同的。<br>
在 dispatch 外再维护一个索引，dispatch 执行的时候 index = i，再执行一次 dispatch 的时候判断 i 是不是小于等于 index，就可以判断当前 next 执行次数。</p>
<p>修改 compose 函数</p>
<pre><code class="language-javascript"><span class="hljs-title function_">compose</span>(<span class="hljs-params">middleware</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(middleware)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;Middleware stack must be an array!&#x27;</span>)
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> fn <span class="hljs-keyword">of</span> middleware) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fn !== <span class="hljs-string">&#x27;function&#x27;</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;Middleware must be composed of functions!&#x27;</span>)
  }
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">let</span> index = -<span class="hljs-number">1</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">dispatch</span> = (<span class="hljs-params">i</span>) =&gt; {
      <span class="hljs-keyword">if</span> (i &lt;= index) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;next() called multiple times&#x27;</span>))
      }
      index = i
      <span class="hljs-keyword">const</span> fn = middleware[i]
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">dispatch</span>(i + <span class="hljs-number">1</span>))
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-number">0</span>)
  }
}
</code></pre>
<p>当最后一个 next 的时候，默认返回一个空函数就行</p>
<pre><code class="language-javascript"><span class="hljs-title function_">compose</span>(<span class="hljs-params">middleware</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(middleware)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;Middleware stack must be an array!&#x27;</span>)
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> fn <span class="hljs-keyword">of</span> middleware) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fn !== <span class="hljs-string">&#x27;function&#x27;</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;Middleware must be composed of functions!&#x27;</span>)
  }
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">let</span> index = -<span class="hljs-number">1</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">dispatch</span> = (<span class="hljs-params">i</span>) =&gt; {
      <span class="hljs-keyword">if</span> (i &lt;= index) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;next() called multiple times&#x27;</span>))
      }
      index = i
      <span class="hljs-comment">// 添加了这一段</span>
      <span class="hljs-keyword">if</span> (i &gt;= middleware.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {}
      <span class="hljs-keyword">const</span> fn = middleware[i]
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">dispatch</span>(i + <span class="hljs-number">1</span>))
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-number">0</span>)
  }
}
</code></pre>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./useSync.js&quot;</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();
app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">cb1</span>(<span class="hljs-params">next</span>) {
  <span class="hljs-title function_">next</span>();
  <span class="hljs-title function_">next</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);
});

app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">cb2</span>(<span class="hljs-params">next</span>) {
  <span class="hljs-title function_">next</span>();
});

app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">cb3</span>(<span class="hljs-params">next</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
  <span class="hljs-title function_">next</span>();
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8889</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`启动成功8889`</span>);
});
</code></pre>
<h3><a id="异步" class="content__heading-anchor"></a>异步</h3>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./useSync.js&quot;</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();
app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (next) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">4</span>);
});

app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (next) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">timeout</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">timeout</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">resolve</span>();
    }, <span class="hljs-number">2000</span>);
  });
}
</code></pre>
<p>底层原理就是基于 Promise 实现的自执行的 Generator 函数，async 最后会返回一个 Promise，await 等于 yield。</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;koa&quot;</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">ctx, next</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">next</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
  });
});

app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">ctx, next</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8889</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`启动成功8889`</span>);
});
</code></pre>
<p>最后一个中间件是一个普通函数，但是上一个中间件却用了 next().then()，也就是认为最后一个中间件是一个 Promise。<br>
在 Koa 是被允许的，也就是 Koa 中兼容了普通函数和 Promise。</p>
<h3><a id="promiseresolve" class="content__heading-anchor"></a>Promise.resolve</h3>
<pre><code class="language-javascript"><span class="hljs-comment">// 函数是Promise直接返回，不是就包一层Promise</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-property">resolve</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">if</span> (fn <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) {
    <span class="hljs-keyword">return</span> fn;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
      <span class="hljs-title function_">resolve</span>(fn);
    });
  }
};
</code></pre>
<p>所以再次修改 compose 函数</p>
<pre><code class="language-javascript"><span class="hljs-title function_">compose</span>(<span class="hljs-params">middleware</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(middleware)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;Middleware stack must be an array!&#x27;</span>)
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> fn <span class="hljs-keyword">of</span> middleware) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fn !== <span class="hljs-string">&#x27;function&#x27;</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;Middleware must be composed of functions!&#x27;</span>)
  }
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">let</span> index = -<span class="hljs-number">1</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">dispatch</span> = (<span class="hljs-params">i</span>) =&gt; {
      <span class="hljs-keyword">if</span> (i &lt;= index) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;next() called multiple times&#x27;</span>))
      }
      index = i
      <span class="hljs-keyword">if</span> (i &gt;= middleware.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {}
      <span class="hljs-keyword">const</span> fn = middleware[i]
      <span class="hljs-comment">// 修改了这</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">fn</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">dispatch</span>(i + <span class="hljs-number">1</span>)))
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-number">0</span>)
  }
}
</code></pre>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./useAsync.js&quot;</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">next</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">next</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
  });
});

app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">next</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">next</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
  });
});
</code></pre>
<pre><code class="language-javascript"><span class="hljs-title function_">compose</span>(<span class="hljs-params">middleware</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(middleware)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;Middleware stack must be an array!&#x27;</span>)
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> fn <span class="hljs-keyword">of</span> middleware) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fn !== <span class="hljs-string">&#x27;function&#x27;</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;Middleware must be composed of functions!&#x27;</span>)
  }
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">let</span> index = -<span class="hljs-number">1</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">dispatch</span> = (<span class="hljs-params">i</span>) =&gt; {
      <span class="hljs-keyword">if</span> (i &lt;= index) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;next() called multiple times&#x27;</span>))
      }
      index = i
      <span class="hljs-comment">// 就这里</span>
      <span class="hljs-keyword">if</span> (i &gt;= middleware.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>()
      <span class="hljs-keyword">const</span> fn = middleware[i]
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">fn</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">dispatch</span>(i + <span class="hljs-number">1</span>)))
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-number">0</span>)
  }
}
</code></pre>
<p>错误情况的兼容</p>
<pre><code class="language-javascript"><span class="hljs-title function_">compose</span>(<span class="hljs-params">middleware</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(middleware)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;Middleware stack must be an array!&#x27;</span>)
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> fn <span class="hljs-keyword">of</span> middleware) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fn !== <span class="hljs-string">&#x27;function&#x27;</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;Middleware must be composed of functions!&#x27;</span>)
  }
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">let</span> index = -<span class="hljs-number">1</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">dispatch</span> = (<span class="hljs-params">i</span>) =&gt; {
      <span class="hljs-comment">// Promise.reject</span>
      <span class="hljs-keyword">if</span> (i &lt;= index) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;next() called multiple times&#x27;</span>))
      index = i
      <span class="hljs-keyword">if</span> (i === middleware.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>()
      <span class="hljs-keyword">const</span> fn = middleware[i]
      <span class="hljs-comment">// try catch</span>
      <span class="hljs-keyword">try</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">fn</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">dispatch</span>(i + <span class="hljs-number">1</span>)))
      } <span class="hljs-keyword">catch</span>(err) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(err)
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-number">0</span>)
  }
}
</code></pre>
<h3><a id="ctx-封装" class="content__heading-anchor"></a>ctx 封装</h3>
<h4><a id="基础结构" class="content__heading-anchor"></a>基础结构</h4>
<p>官方对 ctx 的定义，简单来说就是封装了 node 的 response 和 request，只简单的封装一下 ctx，request，response 和 body<br>
首先，ctx 是一个对象，request 和 response 是 ctx 的一个属性并且也是一个对象。</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> ctx = {};

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = ctx;
</code></pre>
<p>然后上述对 Context 的描述里说到，每个请求都会创建一个新的 Context，并在中间件中引用，也就是说每次 server 接收到请求后（callback 内返回的函数），都会根据 req 和 res 创建一个 Context。</p>
<p>ctx.request：根据 node 的 request 封装而来<br>
ctx.response：根据 node 的 response 封装而来<br>
ctx.req：node 的 request 对象<br>
ctx.res：node 的 response 对象</p>
<p>中间件第一个参数为 Context</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;http&quot;</span>);
<span class="hljs-keyword">const</span> context = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./src/context&quot;</span>);
<span class="hljs-keyword">const</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./src/request&quot;</span>);
<span class="hljs-keyword">const</span> response = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./src/response&quot;</span>);
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Koa</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span> = [];
    <span class="hljs-comment">// 初始化ctx等，引用类型，避免引用</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(context);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">request</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(request);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">response</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(response);
  }
  <span class="hljs-title function_">use</span>(<span class="hljs-params">cb</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span>.<span class="hljs-title function_">push</span>(cb);
  }
  <span class="hljs-title function_">compose</span>(<span class="hljs-params">middleware</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(middleware))
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&quot;Middleware stack must be an array!&quot;</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> fn <span class="hljs-keyword">of</span> middleware) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fn !== <span class="hljs-string">&quot;function&quot;</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&quot;Middleware must be composed of functions!&quot;</span>);
    }
    <span class="hljs-comment">// 接收ctx</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {
      <span class="hljs-keyword">let</span> index = -<span class="hljs-number">1</span>;
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">dispatch</span> = (<span class="hljs-params">i</span>) =&gt; {
        <span class="hljs-keyword">if</span> (i &lt;= index)
          <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;next() called multiple times&quot;</span>));
        index = i;
        <span class="hljs-keyword">if</span> (i === middleware.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();
        <span class="hljs-keyword">const</span> fn = middleware[i];
        <span class="hljs-keyword">try</span> {
          <span class="hljs-comment">// 增加第一个参数为ctx</span>
          <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">fn</span>(ctx, <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">dispatch</span>(i + <span class="hljs-number">1</span>)));
        } <span class="hljs-keyword">catch</span> (err) {
          <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(err);
        }
      };
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-number">0</span>);
    };
  }
  <span class="hljs-title function_">createContext</span>(<span class="hljs-params">req, res</span>) {
    <span class="hljs-comment">// 避免引用</span>
    <span class="hljs-keyword">const</span> context = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);
    <span class="hljs-keyword">const</span> request = (context.<span class="hljs-property">request</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">request</span>));
    <span class="hljs-keyword">const</span> response = (context.<span class="hljs-property">response</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">response</span>));
    <span class="hljs-comment">// req，res为node原生request和response</span>
    <span class="hljs-comment">// 给request和response也赋值req,res是为了利用this获取到原生req,res，然后做二次封装</span>
    context.<span class="hljs-property">req</span> = request.<span class="hljs-property">req</span> = response.<span class="hljs-property">req</span> = req;
    context.<span class="hljs-property">res</span> = request.<span class="hljs-property">res</span> = response.<span class="hljs-property">res</span> = res;
    <span class="hljs-keyword">return</span> context;
  }
  <span class="hljs-title function_">callback</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> fn = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compose</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
      <span class="hljs-comment">// 每个请求都创建一个新的context</span>
      <span class="hljs-keyword">const</span> ctx = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createContext</span>(req, res);
      <span class="hljs-comment">// 传入ctx</span>
      <span class="hljs-title function_">fn</span>(ctx);
      res.<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;111&quot;</span>);
    };
  }
  <span class="hljs-title function_">listen</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callback</span>());
    <span class="hljs-keyword">return</span> server.<span class="hljs-title function_">listen</span>(...args);
  }
}
</code></pre>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./ctx.js&quot;</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">ctx, next</span>) =&gt;</span> {
  <span class="hljs-title function_">next</span>();
});

app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ctx);
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8889</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`启动成功8889`</span>);
});
</code></pre>
<p>输出的 ctx 大概如下结构</p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  request<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    req<span class="hljs-punctuation">:</span> &lt;node req&gt;<span class="hljs-punctuation">,</span>
    res<span class="hljs-punctuation">:</span> &lt;node res&gt;
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  response<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    req<span class="hljs-punctuation">:</span> &lt;node req&gt;<span class="hljs-punctuation">,</span>
    res<span class="hljs-punctuation">:</span> &lt;node res&gt;
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  req<span class="hljs-punctuation">:</span> &lt;node req&gt;<span class="hljs-punctuation">,</span>
  res<span class="hljs-punctuation">:</span> &lt;node res&gt;
<span class="hljs-punctuation">}</span>
</code></pre>
<h3><a id="response--request" class="content__heading-anchor"></a>response &amp; request</h3>
<p>已经给 request 和 response 赋值了，所以可以对 req 和 res 做一层有用的封装</p>
<pre><code class="language-javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// req: &lt;node req&gt;,</span>
  <span class="hljs-comment">// res: &lt;node res&gt;</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">header</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">req</span>.<span class="hljs-property">headers</span>
  },
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">header</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">req</span>.<span class="hljs-property">headers</span> = val
  },
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">url</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">req</span>.<span class="hljs-property">url</span>
  },
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">url</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">req</span>.<span class="hljs-property">url</span> = val
  }
  ... api内的方法
}
</code></pre>
<pre><code class="language-javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// req: &lt;node req&gt;,</span>
  <span class="hljs-comment">// res: &lt;node res&gt;</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">header</span>() {
    <span class="hljs-keyword">const</span> { res } = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> res.<span class="hljs-property">getHeaders</span> === <span class="hljs-string">&quot;function&quot;</span>
      ? res.<span class="hljs-title function_">getHeaders</span>()
      : res.<span class="hljs-property">_headers</span> || {}; <span class="hljs-comment">// Node &lt; 7.7</span>
  },
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">header</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(val, <span class="hljs-number">222</span>);
  },
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">body</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_body</span>;
  },
  <span class="hljs-comment">// 这里只是随便赋了个值，源码内做了很多判断为了适应不同的数据</span>
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">body</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_body</span> = val;
  },
  <span class="hljs-comment">//...</span>
};
</code></pre>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./ctx.js&quot;</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">ctx, next</span>) =&gt;</span> {
  <span class="hljs-title function_">next</span>();
});

app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ctx.<span class="hljs-property">request</span>.<span class="hljs-property">header</span>, <span class="hljs-number">2</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ctx.<span class="hljs-property">request</span>.<span class="hljs-property">url</span>, <span class="hljs-number">3</span>);
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8889</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`启动成功8889`</span>);
});
</code></pre>
<h3><a id="ctx-别名" class="content__heading-anchor"></a>ctx 别名</h3>
<p>这里就对 request 的 header 和 url 做一次实现，其它都同理。<br>
源码内利用 delegates 包做了一层代理，其实也可以用 proxy 等，实现一下 request 的代理。</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> delegate = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;delegates&quot;</span>);
<span class="hljs-keyword">const</span> ctx = {};

<span class="hljs-comment">// 将ctx.request的header和url属性代理到ctx下</span>
<span class="hljs-title function_">delegate</span>(ctx, <span class="hljs-string">&quot;request&quot;</span>).<span class="hljs-title function_">access</span>(<span class="hljs-string">&quot;header&quot;</span>).<span class="hljs-title function_">access</span>(<span class="hljs-string">&quot;url&quot;</span>);

<span class="hljs-comment">// 代理response.body</span>
<span class="hljs-title function_">delegate</span>(ctx, <span class="hljs-string">&quot;response&quot;</span>).<span class="hljs-title function_">access</span>(<span class="hljs-string">&quot;body&quot;</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = ctx;
</code></pre>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./ctx.js&quot;</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">ctx, next</span>) =&gt;</span> {
  <span class="hljs-title function_">next</span>();
});

app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ctx.<span class="hljs-property">request</span>.<span class="hljs-property">url</span>, <span class="hljs-number">1</span>);
  <span class="hljs-comment">// 可以直接访问</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ctx.<span class="hljs-property">url</span>, <span class="hljs-number">2</span>);
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8889</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`启动成功8889`</span>);
});
</code></pre>
<h4><a id="ctxbody" class="content__heading-anchor"></a>ctx.body</h4>
<p>Koa 中给 ctx.body 赋值后，请求结束会识别 ctx.body 的类型然后返回对应的数据</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;koa&quot;</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">ctx, next</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">next</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
});

app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">ctx, next</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
  ctx.<span class="hljs-property">body</span> = <span class="hljs-string">&quot;&lt;html&gt;111&lt;/html&gt;&quot;</span>;
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8889</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`启动成功8889`</span>);
});
<span class="hljs-comment">// node koa.js -&gt; 启动成功8889</span>
<span class="hljs-comment">// Postman请求0.0.0.0:8889 -&gt; 1 2 3</span>
</code></pre>
<p>只需要走完全部中间件的时候，判断 body 类型，然后使用 res.end 结束请求即可</p>
<pre><code class="language-javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Koa</span> {
  <span class="hljs-title function_">callback</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> fn = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compose</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> ctx = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createContext</span>(req, res);
      <span class="hljs-comment">// 中间件全部走完后执行</span>
      <span class="hljs-title function_">fn</span>(ctx).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">respond</span>(ctx));
    };
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">respond</span>(<span class="hljs-params">ctx</span>) {
  <span class="hljs-keyword">const</span> res = ctx.<span class="hljs-property">res</span>;
  <span class="hljs-keyword">let</span> body = ctx.<span class="hljs-property">body</span>;
  <span class="hljs-comment">// 判断body类型，自动设置Content-Type</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> body === <span class="hljs-string">&quot;string&quot;</span>) {
    res.<span class="hljs-title function_">setHeader</span>(
      <span class="hljs-string">&quot;Content-Type&quot;</span>,
      <span class="hljs-regexp">/^\s*&lt;/</span>.<span class="hljs-title function_">test</span>(body) ? <span class="hljs-string">&quot;text/html&quot;</span> : <span class="hljs-string">&quot;text/plain&quot;</span>
    );
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> body === <span class="hljs-string">&quot;object&quot;</span> &amp;&amp; ctx.<span class="hljs-property">body</span> !== <span class="hljs-literal">null</span>) {
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/json&quot;</span>);
    body = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(body);
  }
  <span class="hljs-comment">// 结束请求并返回body</span>
  res.<span class="hljs-title function_">end</span>(body);
}
</code></pre>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./ctx.js&quot;</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">ctx, next</span>) =&gt;</span> {
  <span class="hljs-title function_">next</span>();
});

app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {
  ctx.<span class="hljs-property">body</span> = {
    <span class="hljs-attr">msg</span>: <span class="hljs-string">&quot;成功啦&quot;</span>,
  };
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8889</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`启动成功8889`</span>);
});
</code></pre>
 </article> </section> </main>  <footer class="footer"> <hr class="footer__divide"> <div class="footer__row"> <p class="m-2">
&#169; 2017-2024 <a href="/" class="link">9Sky 九天</a> </p> <div class="m-2"> <ul data-astro-cid-tfcnbjmv> <li data-astro-cid-tfcnbjmv> <a class="link" href="/" data-astro-cid-tfcnbjmv> 
主页
</a> </li> <li data-astro-cid-tfcnbjmv> <a class="link" href="/blog" data-astro-cid-tfcnbjmv>  文章 </a> </li><li data-astro-cid-tfcnbjmv> <a class="link" href="/projects" data-astro-cid-tfcnbjmv>  项目 </a> </li><li data-astro-cid-tfcnbjmv> <a class="link" href="/lab" data-astro-cid-tfcnbjmv>  实验室 </a> </li><li data-astro-cid-tfcnbjmv> <a class="link" href="/about" data-astro-cid-tfcnbjmv>  关于 </a> </li> </ul>  </div> </div> </footer> </body></html> 